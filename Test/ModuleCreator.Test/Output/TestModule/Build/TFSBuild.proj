<?xml version="1.0" encoding="utf-8"?>
<Project
    DefaultTargets="Build"
    xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
    ToolsVersion="12.0">
    <ItemGroup>
        <ProjectToBuild Include="ModuleBuild.proj"/>
    </ItemGroup>

    <Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\TeamBuild\Microsoft.TeamFoundation.Build.targets" />
    <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

    <PropertyGroup>
        <TreatTestFailureAsBuildFailure>true</TreatTestFailureAsBuildFailure>
        <SolutionDirectoryPath Condition="('$(IsDesktopBuild)'=='true')">$(SolutionRoot)\$(ModuleName)</SolutionDirectoryPath>
        <SolutionDirectoryPath Condition="('$(IsDesktopBuild)'!='true')">$(SolutionRoot)</SolutionDirectoryPath>
        <BaseDropDirectory>$(DropLocation)</BaseDropDirectory>
        <BuildDependsOn Condition="('$(IsDesktopBuild)'!='true')">LoadDependencies;</BuildDependsOn>
        <BuildDependsOn Condition="('$(IsDesktopBuild)'=='true')"></BuildDependsOn>
    </PropertyGroup>

    <Target Name="LoadDependencies"  Condition="('$(DropLocation)'!='')">
        <BuildStep
             Condition="('$(IsDesktopBuild)'!='true')"
             Message="Getting Module Dependencies"
             TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
             BuildUri="$(BuildURI)"
            >
            <Output
                TaskParameter="id"
                PropertyName="BuildStepId"
                />
        </BuildStep>

        <Exec ContinueOnError="false"
              IgnoreExitCode="false"
              Command='"Powershell" ".\LoadDependancies.ps1" $(SolutionDirectoryPath) $(BaseDropDirectory)'>
        </Exec>

        <BuildStep
          Condition="('$(IsDesktopBuild)'!='true')"
          TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
          BuildUri="$(BuildUri)"
          Id="$(BuildStepId)"
          Status="Succeeded" />

        <OnError ExecuteTargets="MarkBuildStepAsFailed" />
    </Target>

    <Target Name="Build" DependsOnTargets="BuildDependsOn">
        <MSBuild Projects="@(ProjectToBuild)"/>
    </Target>

</Project>