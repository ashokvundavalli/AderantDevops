<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="14.0">

  <PropertyGroup>
    <RunTestsDependsOn>
      CreatePlan;
      CollectTestAssemblies;
      SetupTestProperties;
    </RunTestsDependsOn>
  </PropertyGroup>

  <Target Name="CollectTestAssemblies">

    <GetBuildOutputs>
      <Output TaskParameter="TrackedProjects" ItemName="TrackedProjects" />
      <Output TaskParameter="SolutionRoots" ItemName="SolutionRoots" />
    </GetBuildOutputs>

    <Message Text="Looking for test assemblies in these directories:" />
    <Message Text="%(TrackedProjects.OutputPath)" />
  </Target>


  <Target Name="SetupTestProperties">
    <!-- Collect all assemblies to use as test dependencies -->
    <ItemGroup>
      <AllStagedDlls Include="$(ArtifactStagingDirectory)**\*.dll"/>
      <AllDirectoriesWithDlls Include="@(AllStagedDlls->'%(RootDir)%(Directory)'->Distinct())"/>
    </ItemGroup>

    <PropertyGroup>
      <UnitTestAssemblies>@(TestAssemblies->'"%(FullPath)"', ',')</UnitTestAssemblies>
      <VsTestWorkingDirectory>$(SolutionRoot)</VsTestWorkingDirectory>

      <CodeCoverage Condition="'$(CodeCoverage)' == ''">false</CodeCoverage>

      <!-- VSTest Setup -->
      <VsTestDirectory Condition="'$(VsTestDirectory)' == ''">$(VsCommonTools)..\IDE\CommonExtensions\Microsoft\TestWindow</VsTestDirectory>
      <PathToTestTool>$(VsTestDirectory)\vstest.console.exe</PathToTestTool>
      <PathToTestTool>$([System.IO.Path]::GetFullPath('$(PathToTestTool)'))</PathToTestTool>

      <IsolationSwitch>/InIsolation</IsolationSwitch>
      <RunUnitTestsInParallel>$([MSBuild]::ValueOrDefault('$(RunUnitTestsInParallel)', 'true'))</RunUnitTestsInParallel>
      <ParallelSwitch Condition="'$(RunUnitTestsInParallel)' == 'true'">/Parallel</ParallelSwitch>

      <TestAdapterSwitch Condition="'$(PSTests)' == 'true'">/TestAdapterPath:"$(BuildScriptsDirectory)..\Build.Tools"</TestAdapterSwitch>
      <ResultsFileSwitch Condition="'$(ResultsFileSwitch)' == ''">/Logger:trx</ResultsFileSwitch>
      <RunSettingsSwitch>/Settings:$(TestWorkingDirectory)default.runsettings</RunSettingsSwitch>

      <AllDirectoriesWithDlls>@(AllDirectoriesWithDlls->'"%(FullPath)"', ',')</AllDirectoriesWithDlls>
    </PropertyGroup>
  </Target>


  <Target Name="RunTests"
          Outputs="%(SolutionRoots.Identity)"
          Condition="'$(RunTests)' != 'false' And '@(ImpactedTestAssemblies)' != ''"
          DependsOnTargets="$(RunTestsDependsOn)">

    <PropertyGroup>
      <TestRunDirectory>%(SolutionRoots.Identity)</TestRunDirectory>
    </PropertyGroup>

    <ItemGroup>
      <ProjectsForThisRoot Include="@(TrackedProjects->WithMetadataValue('SolutionRoot', '$(TestRunDirectory)'))" />
      <TestAssemblyDirectories Include="@(ProjectsForThisRoot->'%(OutputPath)'->Distinct())" />
    </ItemGroup>

    <ItemGroup>
      <CandidateTestAssemblies Include="%(TestAssemblyDirectories.FullPath)**\*UnitTest*.dll"
                               Exclude="%(TestAssemblyDirectories.FullPath)**\*Helpers*.dll;
                                        %(TestAssemblyDirectories.FullPath)**\Microsoft.*;
                                        %(TestAssemblyDirectories.FullPath)**\System.*;" />

      <AssemblyDependencies Include="%(TestAssemblyDirectories.FullPath)**\*.dll;
                                     %(TestAssemblyDirectories.FullPath)**\*.exe"
                            Exclude="@(CandidateTestAssemblies)" />
    </ItemGroup>

    <FindInList
      MatchFileNameOnly="true"
      CaseSensitive="false"
      List="@(CandidateTestAssemblies)"
      ItemSpecToFind="%(ImpactedTestAssemblies.Identity)">
      <Output TaskParameter="ItemFound" ItemName="TestAssemblies" />
    </FindInList>

    <!-- Determine if we can run the tests using the 64-bit test runner -->
    <GetAssemblyPlatform
      Condition="'$(Use32BitTestRunner)' == ''"
      Assemblies="@(TestAssemblies)"
      AssemblyDependencies="@(AssemblyDependencies)">
      <Output ItemName="AssembliesTargetingAnyCpu" TaskParameter="Assemblies" />
      <Output ItemName="AssembliesTargetingX86" TaskParameter="AssembliesTargetingX86" />
      <Output ItemName="AssembliesTargetingX64" TaskParameter="AssembliesTargetingX64" />
      <Output PropertyName="Use32BitTestRunner" TaskParameter="MustRun32Bit" />
      <Output PropertyName="AssemblyPlatformDataKey" TaskParameter="AssemblyPlatformDataKey" />
    </GetAssemblyPlatform>

    <Message Text="Assembly: %(AssembliesTargetingAnyCpu.FileName) -> Platform: %(AssembliesTargetingAnyCpu.PEKind) (AnyCPU)" Condition="'@(AssembliesTargetingAnyCpu)' != ''" />
    <Message Text="Assembly: %(AssembliesTargetingX64.FileName) -> Platform: %(AssembliesTargetingX64.PEKind) (x64)" Condition="'@(AssembliesTargetingX64)' != ''" />
    <Message Text="Assembly: %(AssembliesTargetingX86.FileName) -> Platform: %(AssembliesTargetingX86.PEKind) (x86)" Condition="'@(AssembliesTargetingX86)' != ''" />

    <!--<CreateItem Include="_Assemblies" PreserveExistingMetadata="true">

    </CreateItem>-->

    <!--<CreateItem Include="@(_NuGetContentItems)" Condition="'@(_NuGetContentItems)' != ''">
      <Output TaskParameter="Include" ItemName="%(_NuGetContentItems.NuGetItemType)" />
    </CreateItem>-->

    <ItemGroup>
      <_Assemblies Include="@(AssembliesTargetingAnyCpu)" />
      <_Assemblies Include="@(AssembliesTargetingX64)" />
      <_Assemblies Include="@(AssembliesTargetingX86)" />
    </ItemGroup>

  </Target>


  <Target Name="InvokeTestRunner"
          AfterTargets="RunTests"
          Inputs="@(_Assemblies)"
          Outputs="%(Platform)">

    <PropertyGroup>
      <PlatformSwitch>/Platform:%(_Assemblies.Platform)</PlatformSwitch>
      <UnitTestAssemblies>@(_Assemblies->'"%(FullPath)"', ',')</UnitTestAssemblies>
    </PropertyGroup>

    <!-- TaskObjectKey will be the task object from GetAssemblyPlatform -->
    <PowerShellScript
      Condition="'$(UnitTestAssemblies)' != ''"
      ScriptBlock='
$ErrorActionPreference = "Stop"
$InformationPreference = "Continue"

$testTool = "$(PathToTestTool)"
$testToolArgs = "$(ResultsFileSwitch) $(PlatformSwitch) $(ParallelSwitch)"
$testRunDirectory = "$(TestRunDirectory)"
$workingDirectory = "$(SolutionRoot)"
$isDesktopBuild = $$(IsDesktopBuild)
$referencePaths = $(AllDirectoriesWithDlls)
$testFiles = $(UnitTestAssemblies)
$referencesToFind = $$(AssemblyPlatformDataKey).ReferencesToFind

Write-Information $referencesToFind

. Testing\RunTests.ps1 -PathToTestTool $testTool -ToolArgs $testToolArgs -WorkingDirectory $workingDirectory -SolutionRoot $testRunDirectory -IsDesktopBuild:$isDesktopBuild -ReferencePaths $referencePaths -TestAssemblies $testFiles -ReferencesToFind $referencesToFind'
      OnErrorReason="Test failure"
      TaskObjects="$(AssemblyPlatformDataKey)" />

    <OnError ExecuteTargets="ShowTestFailureHelp" />

  </Target>


  <Target Name="ShowTestFailureHelp">
    <Message Text="!!!" Importance="High" />
    <Message Text="Run 'bm -Target RunTests' to issue another test run" Importance="High" />
    <Message Text="!!!" Importance="High" />
  </Target>

</Project>