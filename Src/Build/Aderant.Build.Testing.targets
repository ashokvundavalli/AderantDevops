<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         ToolsVersion="Current"
         TreatAsLocalProperty="SolutionRoot">

  <PropertyGroup>
    <TestRunInstanceId Condition="'$(TestRunInstanceId)' == ''">$([System.Guid]::NewGuid().ToString('N'))</TestRunInstanceId>
  </PropertyGroup>

  <Import Project="Aderant.Build.Common.targets" Condition="'$(AderantCommonTargetsImported)' != 'true'" />


  <!-- Returns the ExcludedTestResolutionFiles ItemGroup from the parameters file or becomes overridden by the target in the parameters file -->
  <Target Name="GetTestExclusionFiles"
          Returns="@(ExcludedTestResolutionFiles)">

    <ItemGroup>
      <ExcludedTestResolutionFiles Include="@(ExcludedTestResolutionFiles)" />
    </ItemGroup>
  </Target>

  <!-- Only conditionally import the parameters file as it is very slow due to the wide globbing expressions -->
  <Import Project="$(ParametersFile)" Condition="'$(ImportParametersFile)' == 'true' And Exists($(ParametersFile))" />


  <PropertyGroup>
    <RunTestsDependsOn>
      SetupGlobalTestProperties;
      CollectProjectsInBuild
    </RunTestsDependsOn>

    <RunTestsDependsOnInternal>
      SetupTestProperties;
      CollectTestAssemblyDirectories;
      CollectAssemblyPlatforms;
      RunTestAssemblies;
    </RunTestsDependsOnInternal>
  </PropertyGroup>


  <Target Name="RunTestsCore"
          Condition="'$(RunTests)' != 'false' Or '$(_RunIntegrationTests)' != 'false'"
          DependsOnTargets="$(RunTestsDependsOn)">
  </Target>


  <Target Name="SetupGlobalTestProperties">
    <PropertyGroup>
      <!-- VSTest Setup -->
      <VsTestDirectory Condition="'$(VsTestDirectory)' == ''">$(VsCommonTools)..\IDE\CommonExtensions\Microsoft\TestWindow</VsTestDirectory>
      <PathToTestTool>$(VsTestDirectory)\vstest.console.exe</PathToTestTool>
      <PathToTestTool>$([System.IO.Path]::GetFullPath('$(PathToTestTool)'))</PathToTestTool>
    </PropertyGroup>


    <!-- Run GetTestExclusionFiles in this project or use the one from the parameters file -->
    <MSBuild Projects="$(MSBuildThisFileFullPath)"
             Properties="ImportParametersFile=true;ArtifactStagingDirectory=$(ArtifactStagingDirectory)"
             Targets="GetTestExclusionFiles">
      <Output TaskParameter="TargetOutputs" ItemName="ExcludedTestResolutionFiles" />
    </MSBuild>


    <!-- Collect all assemblies to use as test dependencies -->
    <ItemGroup>
      <NugetPackageFoldersToIgnore Include="en-US;Microsoft.VC90.CRT" />

      <AllStagedDlls Include="$(ArtifactStagingDirectory)out\**\*.dll" Exclude="@(ExcludedTestResolutionFiles)" />

      <!-- Turn the files into directories, FileName becomes the folder name -->
      <AllDirectoriesWithDlls Include="@(AllStagedDlls->'%(RootDir)%(Directory)'->Distinct())" />

      <!-- Trim the path separator off so %(Filename) resolves -->
      <AllDirectoriesWithDlls Include="@(AllDirectoriesWithDlls->'%(RootDir)%(Directory)'->TrimEnd('\')->Distinct())" />
      <AllDirectoriesWithDlls Remove="@(AllDirectoriesWithDlls)" Condition="'%(Filename)' == '@(NugetPackageFoldersToIgnore->'%(Filename)')'" />
    </ItemGroup>

  </Target>


  <Target Name="CollectProjectsInBuild">
    <GetBuildOutputs>
      <Output TaskParameter="TrackedProjects" ItemName="TrackedProjects" />
      <Output TaskParameter="SolutionRoots" ItemName="SolutionRoots" />
    </GetBuildOutputs>

    <ItemGroup>
      <ProjectItems Include="$(MSBuildProjectFullPath)">
        <Properties>
          SolutionRoot=%(SolutionRoots.Identity);
          TestRunInstanceId=$(TestRunInstanceId);
          ArtifactStagingDirectory=$(ArtifactStagingDirectory);
          ImpactedTestAssemblies=$(ImpactedTestAssemblies);
          AllDirectoriesWithDlls=@(AllDirectoriesWithDlls);
          TestResultFileDrop=$(TestResultFileDrop);
          VsTestDirectory=$(VsTestDirectory);
          PathToTestTool=$(PathToTestTool)
        </Properties>
      </ProjectItems>
    </ItemGroup>

    <!-- RunTestsForSolutionRootInParallel: Specifies that all directories with tests will be run in parallel or one at a time -->
    <MSBuild Projects="@(ProjectItems)"
             Targets="RunTestsForSolutionRoot"
             BuildInParallel="$(RunTestsForSolutionRootInParallel)">
      <Output TaskParameter="TargetOutputs" PropertyName="RunSettingsFileXml" />
    </MSBuild>

    <CallTarget Targets="RemoveTestRunFiles" />

    <OnError ExecuteTargets="RemoveTestRunFiles;ShowTestFailureHelp" />
  </Target>


  <Target Name="RunTestsForSolutionRoot" DependsOnTargets="$(RunTestsDependsOnInternal)" Returns="$(RunSettingsFileXml)">
  </Target>


  <Target Name="SetupTestProperties">
    <Error Condition="'$(SolutionRoot)' == ''" Text="SolutionRoot is undefined" />

    <!-- Expand the provided test dependency collection into an item group -->
    <ItemGroup>
      <AllDirectoriesWithDlls Include="$(AllDirectoriesWithDlls)" />
    </ItemGroup>

    <PropertyGroup>
      <AssembliesUnderTest>@(TestAssemblies->'"%(FullPath)"', ',')</AssembliesUnderTest>
      <VsTestWorkingDirectory>$(SolutionRoot)</VsTestWorkingDirectory>

      <CodeCoverage Condition="'$(CodeCoverage)' == ''">false</CodeCoverage>

      <IsolationSwitch>/InIsolation</IsolationSwitch>
      <RunTestsInParallel>$([MSBuild]::ValueOrDefault('$(RunTestsInParallel)', 'true'))</RunTestsInParallel>
      <ParallelSwitch Condition="'$(RunTestsInParallel)' == 'true'">/Parallel</ParallelSwitch>

      <TestAdapterSwitch Condition="'$(PSTests)' == 'true'">/TestAdapterPath:"$(BuildScriptsDirectory)..\Build.Tools"</TestAdapterSwitch>
      <ResultsFileSwitch Condition="'$(ResultsFileSwitch)' == ''">/Logger:trx</ResultsFileSwitch>

      <TestPattern>$([MSBuild]::ValueOrDefault('$(TestPattern)', 'UnitTest'))</TestPattern>

      <TestAdapterPath>$([System.IO.Path]::Combine( $(SolutionRoot), "packages\development\MSTest.TestAdapter\build\_common" ))</TestAdapterPath>
    </PropertyGroup>
  </Target>


  <Target Name="CollectTestAssemblyDirectories">
    <PropertyGroup>
      <!-- Ensure that any symbols like $ (from the current account) do not get escaped -->
      <TestRunDirectory>$([MSBuild]::Unescape($(SolutionRoot)))</TestRunDirectory>
      <RunSettingsPropFile>$(TestRunDirectory)\Build\TFSBuild.proj</RunSettingsPropFile>
    </PropertyGroup>

    <!-- Retrieve contextual data from the build service -->
    <GetBuildOutputs
        SolutionRoot="$(TestRunDirectory)"
        NormalizeOutputPath="true">
      <Output TaskParameter="TrackedProjects" ItemName="ProjectsForThisRoot" />
    </GetBuildOutputs>

    <ItemGroup>
      <TestAssemblyDirectories Include="@(ProjectsForThisRoot->'%(OutputPath)'->Distinct())" />
    </ItemGroup>

  </Target>


  <Target Name="CollectAssemblyPlatforms" Condition="'@(TestAssemblyDirectories->Count())' != '0'">
    <Error Condition="$(TestRunInstanceId) == ''" Text="TestRunInstanceId is undefined" />

    <Message Text="Looking for test assemblies in these directories:" />
    <Message Text="%(TestAssemblyDirectories.FullPath)" />

    <ItemGroup>
      <_CustomRunSettingFiles Remove="@(_CustomRunSettingFiles)" />
    </ItemGroup>


    <MSBuild Projects="$(MSBuildThisFileFullPath)"
             Condition="'$(RunSettingsPropFile)' != '' And Exists('$(RunSettingsPropFile)')"
             Targets="GetUseCustomRunSettings"
             Properties="RunSettingsPropFile=$(RunSettingsPropFile);AderantCommonTargetsImported=true"
             BuildInParallel="true"
             ContinueOnError="true">
      <Output TaskParameter="TargetOutputs" PropertyName="UseCustomRunSettings" />
    </MSBuild>


    <!-- Customization point - extract an ItemGroup called RunSettings from the project cone -->
    <MSBuild Projects="$(MSBuildThisFileFullPath)"
             Condition="Exists('$(RunSettingsPropFile)')"
             Targets="GetCustomTestSettings"
             BuildInParallel="true"
             Properties="RunSettingsPropFile=$(RunSettingsPropFile);ArtifactStagingDirectory=$(ArtifactStagingDirectory);AderantCommonTargetsImported=true"
             ContinueOnError="true">
      <Output TaskParameter="TargetOutputs" ItemName="RunSettings" />
    </MSBuild>


    <!-- Combine global properties and any local properties into a single parameter set -->
    <BuildTestRunParametersXml
      TestRunParameters="@(RunSettings)">
      <Output TaskParameter="TestRunParameters" ItemName="RunSettings" />
    </BuildTestRunParametersXml>


    <CreateItem Include="%(TestAssemblyDirectories.FullPath)\*.runsettings">
      <Output TaskParameter="Include" ItemName="_CustomRunSettingFiles"/>
    </CreateItem>

    <Error Text="More than one custom run settings file is present: @(TestAssemblyDirectories)" Condition="'$(UseCustomRunSettings)' == 'True' And '@(_CustomRunSettingFiles->Count())' &gt; 1" />

    <PropertyGroup>
      <UsingCustomRunSettings>false</UsingCustomRunSettings>
      <RunSettingsFile Condition="'$(UseCustomRunSettings)' == 'True' And '@(_CustomRunSettingFiles->Count())' != '0'">@(_CustomRunSettingFiles)</RunSettingsFile>

      <UsingCustomRunSettings Condition="'$(RunSettingsFile)' != ''">true</UsingCustomRunSettings>
      <RunSettingsFile Condition="'$(RunSettingsFile)' == '' Or !Exists('$(RunSettingsFile)')">$(MSBuildThisFileDirectory)Testing\default.runsettings</RunSettingsFile>
    </PropertyGroup>

    <!-- Copy the run settings template file and apply any custom transforms -->
    <Copy SourceFiles="$(RunSettingsFile)"
          DestinationFiles="$([System.IO.Path]::Combine($([System.IO.Path]::GetTempPath()), $(TestRunInstanceId), $([System.Guid]::NewGuid().ToString('N')).xml))">
      <Output TaskParameter="DestinationFiles" PropertyName="RunSettingsFile" />
    </Copy>

    <XmlPoke Condition="'@(RunSettings->Count())' != '0'"
             XmlInputPath="$(RunSettingsFile)"
             Query="%(RunSettings.Identity)"
             Value="%(RunSettings.Value)" />

    <!-- Returned so the unit tests can inspect this value -->
    <PropertyGroup>
      <RunSettingsFileXml>$([System.IO.File]::ReadAllText('$(RunSettingsFile)'))</RunSettingsFileXml>
    </PropertyGroup>

    <Message Text="TestRunDirectory: $(TestRunDirectory)
RunSettingsFile: $(RunSettingsFile)" />

    <ItemGroup>
      <CandidateTestAssemblies Include="%(TestAssemblyDirectories.FullPath)\**\*$(TestPattern)*.dll"
                               Exclude="%(TestAssemblyDirectories.FullPath)\**\*Helper*.dll;
                                        %(TestAssemblyDirectories.FullPath)\**\Microsoft.*;
                                        %(TestAssemblyDirectories.FullPath)\**\System.*;" />

      <AssemblyDependencies Include="%(TestAssemblyDirectories.FullPath)\**\*.dll;
                                     %(TestAssemblyDirectories.FullPath)\**\*.exe"
                            Exclude="@(CandidateTestAssemblies)" />
    </ItemGroup>

    <ItemGroup>
      <ImpactedTestAssemblies Include="$(ImpactedTestAssemblies)" />
    </ItemGroup>

    <FindInList
      Condition="'@(ImpactedTestAssemblies->Count())' != '0'"
      MatchFileNameOnly="true"
      CaseSensitive="false"
      List="@(CandidateTestAssemblies)"
      ItemSpecToFind="%(ImpactedTestAssemblies.Identity)">
      <Output TaskParameter="ItemFound" ItemName="TestAssemblies" />
    </FindInList>

    <ItemGroup Condition="'@(ImpactedTestAssemblies->Count())' == '0' And '$(IsDesktopBuild)' == 'true'">
      <TestAssemblies Include="@(CandidateTestAssemblies)" />
    </ItemGroup>

    <!-- Determine if we can run the tests using the 64-bit test runner -->
    <GetAssemblyPlatform
      Condition="'$(Use32BitTestRunner)' == '' And '@(TestAssemblies)' != ''"
      Assemblies="@(TestAssemblies)"
      AssemblyDependencies="@(AssemblyDependencies)">
      <Output ItemName="AssembliesWithTargetPlatform" TaskParameter="Assemblies" />
      <Output ItemName="AssembliesTargetingX86" TaskParameter="AssembliesTargetingX86" />
      <Output ItemName="AssembliesTargetingX64" TaskParameter="AssembliesTargetingX64" />
      <Output PropertyName="Use32BitTestRunner" TaskParameter="MustRun32Bit" />
    </GetAssemblyPlatform>

    <Message Text="Assembly: %(AssembliesWithTargetPlatform.FileName) -> Platform: %(AssembliesWithTargetPlatform.PEKind) (AnyCPU)" Condition="'@(AssembliesWithTargetPlatform)' != ''" />
    <Message Text="Assembly: %(AssembliesTargetingX64.FileName) -> Platform: %(AssembliesTargetingX64.PEKind) (x64)" Condition="'@(AssembliesTargetingX64)' != ''" />
    <Message Text="Assembly: %(AssembliesTargetingX86.FileName) -> Platform: %(AssembliesTargetingX86.PEKind) (x86)" Condition="'@(AssembliesTargetingX86)' != ''" />
    <Message Condition="'@(AssembliesWithTargetPlatform)' != '' And '$(TestPattern)' == 'IntegrationTest'" Text="Assembly: %(AssembliesWithTargetPlatform.FileName) -> CIEnabled: %(AssembliesWithTargetPlatform.CIEnabled)" />

    <ItemGroup>
      <_Assemblies Condition="'$(TestPattern)' == 'UnitTest'" Include="@(AssembliesWithTargetPlatform)">
        <SolutionRoot>$(SolutionRoot)</SolutionRoot>
        <TestRunDirectory>$(TestRunDirectory)</TestRunDirectory>
        <RunSettingsFile>$(RunSettingsFile)</RunSettingsFile>
      </_Assemblies>
      <_Assemblies Condition="'@(_Assemblies)' == '' And '$(DeployEnvironment)' != 'true'" Include="@(AssembliesWithTargetPlatform)">
        <SolutionRoot>$(SolutionRoot)</SolutionRoot>
        <TestRunDirectory>$(TestRunDirectory)</TestRunDirectory>
        <RunSettingsFile>$(RunSettingsFile)</RunSettingsFile>
      </_Assemblies>
      <_Assemblies Condition="'@(_Assemblies)' == '' And %(AssembliesWithTargetPlatform.CIEnabled) == 'true'" Include="@(AssembliesWithTargetPlatform)">
        <SolutionRoot>$(SolutionRoot)</SolutionRoot>
        <TestRunDirectory>$(TestRunDirectory)</TestRunDirectory>
        <RunSettingsFile>$(RunSettingsFile)</RunSettingsFile>
      </_Assemblies>
    </ItemGroup>

  </Target>


  <Target Name="RunTestAssemblies" Inputs="@(_Assemblies)" Outputs="%(_Assemblies.TestRunDirectory);%(_Assemblies.Platform)">
    <Message Text="Assembly Test Filters: '%(_Assemblies.CICategory)'" />

    <PropertyGroup>
      <PlatformSwitch>/Platform:%(_Assemblies.Platform)</PlatformSwitch>
      <TestCaseFilter Condition="'%(_Assemblies.CICategory)' != ''">/TestCaseFilter:&quot;%(_Assemblies.CICategory)&quot;</TestCaseFilter>
      <TestRunDirectory>%(_Assemblies.TestRunDirectory)</TestRunDirectory>
      <AssembliesUnderTest>@(_Assemblies->'"%(FullPath)"', ' ')</AssembliesUnderTest>

      <AdditionalVariables Condition="'$(TestPattern)' != '' And '$(TestPattern)' == 'IntegrationTest'">
        $additionalEnvironmentVariables.Add('EXPERT_ENVIRONMENT_URL', '$(ExpertEnvironmentUrl)');
        $additionalEnvironmentVariables.Add('EXPERT_SOURCE_DIRECTORY', '$(ExpertSourceDirectory)');
      </AdditionalVariables>
    </PropertyGroup>

    <ItemGroup>
      <ScriptArguments Include="_">
        <PathToTestTool>$(PathToTestTool)</PathToTestTool>
        <ToolArgs>$(ResultsFileSwitch) $(PlatformSwitch) $(TestCaseFilter) $(ParallelSwitch)</ToolArgs>
        <WorkingDirectory>$(SolutionRoot)</WorkingDirectory>
        <SolutionRoot>$(TestRunDirectory)</SolutionRoot>
        <TestAdapterPath>$(TestAdapterPath)</TestAdapterPath>
        <IsDesktopBuild>$$(IsDesktopBuild)</IsDesktopBuild>
        <ReferencePaths>@(AllDirectoriesWithDlls)</ReferencePaths>
        <TestAssemblies>$(AssembliesUnderTest)</TestAssemblies>
        <RunInParallel>$$(RunTestsInParallel)</RunInParallel>
        <RunSettingsFile>%(_Assemblies.RunSettingsFile)</RunSettingsFile>
        <UsingCustomRunSettingsFile>$(UsingCustomRunSettings)</UsingCustomRunSettingsFile>
        <TestResultFileDrop>$(TestResultFileDrop)</TestResultFileDrop>
      </ScriptArguments>
    </ItemGroup>

    <PowerShellScript
      Condition="'$(AssembliesUnderTest)' != ''"
      ScriptArguments="@(ScriptArguments)"
      ScriptBlock="
$ErrorActionPreference = 'Stop'
$InformationPreference = 'Continue'
$additionalEnvironmentVariables = @{}
$(AdditionalVariables)
. '$(MSBuildThisFileDirectory)Testing\RunTests.ps1' @args -AdditionalEnvironmentVariables $additionalEnvironmentVariables"
      OnErrorReason="Test failure" />

  </Target>


  <Target Name="RemoveTestRunFiles">
    <Error Condition="$(TestRunInstanceId) == ''" Text="TestRunInstanceId is undefined" />

    <RemoveDir Directories="$([System.IO.Path]::Combine($([System.IO.Path]::GetTempPath()), $(TestRunInstanceId)))"
               ContinueOnError="true" />
  </Target>


  <Target Name="ShowTestFailureHelp" Condition="'$(IsDesktopBuild)' == 'true'">
    <Message Text="!!!" Importance="High" />
    <Message Text="Run 'bm -Target RunTests' to issue another test run" Importance="High" />
    <Message Text="!!!" Importance="High" />
  </Target>


  <!-- Imports the props file when GetCustomTestSettings is invoked -->
  <Import Project="$(RunSettingsPropFile)" Condition="Exists('$(RunSettingsPropFile)')" />

  <Target Name="GetUseCustomRunSettings" Returns="$(UseCustomRunSettings)">
    <!-- Target that returns whether or not a custom runsettings file should be used from a downstream project -->
  </Target>

  <Target Name="GetCustomTestSettings" Returns="@(RunSettings)">
    <!-- Target that returns any custom run settings from a downstream project -->
  </Target>



</Project>