<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="14.0">

  <Import Project="$(MSBuildThisFileDirectory)Aderant.wpp.content.v3.proj" Condition="'$(IsWebOrMobile)' == 'true' And '$(WebDependencyVersion)' == '3'" />

  <PropertyGroup>
    <WppCommonTargetsImported>true</WppCommonTargetsImported>
  </PropertyGroup>

  <UsingTask
        TaskName="WriteSharedContentFile"
        TaskFactory="CodeTaskFactory"
        AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <OutputFile ParameterType="System.String" Required="true" />
      <PathPropertyName ParameterType="System.String" Required="true" />
      <ProjectRootDirectory ParameterType="System.String" Required="true" />
      <ProjectItems ParameterType="Microsoft.Build.Framework.ITaskItem[]" />
      <AssetFilter ParameterType="Microsoft.Build.Framework.ITaskItem[]" />
    </ParameterGroup>

    <Task>
      <Reference Include="System.Xml" />
      <Using Namespace="System" />
      <Using Namespace="System.Xml" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        if (ProjectItems == null || ProjectItems.Length == 0) {
            throw new ArgumentException("No items provided to content writer");
        }

        Log.LogMessage("Writing " + ProjectItems.Length + " items....");

        var ns = "http://schemas.microsoft.com/developer/msbuild/2003";

        XmlWriterSettings settings = new XmlWriterSettings {
            Indent = true
        };

        string pathVariable = @"(" + PathPropertyName + ")";

        using (var w = XmlWriter.Create(OutputFile, settings)) {
            w.WriteStartElement("Project", ns);

            w.WriteStartElement("Import");
            w.WriteAttributeString("Project", "SharedItems.proj");
            w.WriteAttributeString("Condition", "Exists('SharedItems.proj')");
            w.WriteEndElement();

            w.WriteStartElement("PropertyGroup");
            w.WriteStartElement(PathPropertyName);
            w.WriteAttributeString("Condition", string.Format("'$" + "({0})' == ''", PathPropertyName));

            // Need to uglify this string as we want the property expression, not the evalauted property value as
            // if would always point to THIS file which wouldn't be useful. THis happens as the engine swaps the value as
            // this code is just a property expression itself
            w.WriteString(string.Format("$" + "({0})\\", "MSBuildThisFileDirectory"));
            w.WriteEndElement();
            w.WriteEndElement();

            w.WriteStartElement("ItemGroup");

            foreach (var file in ProjectItems) {
                var link = file.GetMetadata("Link");

                var type = file.GetMetadata("Type");
                if (string.IsNullOrWhiteSpace(type)) {
                    type = "Content";
                }

                string fileAndExtension = file.GetMetadata("Filename") + file.GetMetadata("Extension");
                string fileRelativePath = file.GetMetadata("RelativeDir").Replace(ProjectRootDirectory, "") + fileAndExtension;

                w.WriteStartElement(type);
                w.WriteAttributeString("Include", "$" + pathVariable + fileRelativePath);

                w.WriteStartElement("Link");
                w.WriteString(link);
                w.WriteEndElement();

                //string comment = "";
                //var names = file.MetadataNames;
                //foreach (var name in names) {
                //  comment += "\r\n" + (string)name + ":" + file.GetMetadata((string)name);
                //}
                //w.WriteComment(comment);

                w.WriteStartElement("Visible");
                w.WriteString("true");
                w.WriteEndElement();

                w.WriteEndElement();
            }

            w.WriteEndElement();
            w.WriteEndElement();
        }
]]>
      </Code>
    </Task>
  </UsingTask>


  <Target Name="CollectSharedProjectItems">
    <PropertyGroup>
      <ScriptsDirectory Condition="'$(ScriptsDirectory)' == ''">$(MSBuildProjectDirectory)\</ScriptsDirectory>
      <ScriptsDirectory Condition="'$(ScriptsDirectory)' != '' and !HasTrailingSlash('$(ScriptsDirectory)')">$(ScriptsDirectory)\</ScriptsDirectory>
      <GlobExpression Condition="'$(GlobExpression)' == ''">**\</GlobExpression>

      <WebProjectName Condition="'$(WebProjectName)' == ''">$(MSBuildProjectName)</WebProjectName>
      <GlobExpression Condition="'$(UseProjectNameWhenCollectingSharedContent)' == ''">$(WebProjectName)\**</GlobExpression>

      <IncludeJSFiles Condition="'$(IncludeJSFiles)' == ''">true</IncludeJSFiles>
    </PropertyGroup>

    <!--Scripts-->
    <ItemGroup>
      <_FilesForSharedProject Condition="'$(IncludeJSFiles)' == 'true'"
                              Include="$(ScriptsDirectory)Scripts\$(GlobExpression)*.js"
                              Exclude="$(ScriptsDirectory)Scripts\**\ThirdParty.*\**">
        <Link>Scripts\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)Scripts\$(GlobExpression)*.d.ts"
                              Exclude="$(ScriptsDirectory)Scripts\**\ThirdParty.*\**">
        <Link>Scripts\</Link>
        <Type>TypeScriptCompile</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)Scripts\$(GlobExpression)*.html">
        <Link>Scripts\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <!-- Content -->
    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)Content\$(GlobExpression)*"
                              Exclude="$(ScriptsDirectory)Content\**\ThirdParty.*\**">
        <Link>Content\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <!-- ViewModels -->
    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)ViewModels\$(GlobExpression)*.d.ts"
                              Exclude="$(ScriptsDirectory)ViewModels\**\ThirdParty.*\**">
        <Link>ViewModels\</Link>
        <Type>TypeScriptCompile</Type>
      </_FilesForSharedProject>

      <_FilesForSharedProject Condition="'$(IncludeJSFiles)' == 'true'"
                              Include="$(ScriptsDirectory)ViewModels\$(GlobExpression)*.js"
                              Exclude="$(ScriptsDirectory)ViewModels\**\ThirdParty.*\**">
        <Link>ViewModels\</Link>
        <Type>TypeScriptCompile</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <!-- Helpers -->
    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)Helpers\$(GlobExpression)*.xml">
        <Link>Helpers\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <ItemGroup>
      <_FilesForSharedProject Include="$(ScriptsDirectory)Views\Shared\$(GlobExpression)\*.cshtml">
        <Link>Views\Shared\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <ItemGroup Condition="'$(IncludeAuthenticationFiles)' == 'true'">
      <_FilesForSharedProject Include="$(ScriptsDirectory)Authentication\**\*">
        <Link>Authentication\</Link>
        <Type>Content</Type>
      </_FilesForSharedProject>

      <_FilesForSharedProject Include="$(ScriptsDirectory)ManualLogOn\$(GlobExpression)*">
        <Link>ManualLogOn\</Link>
        <IncludeProjectName>false</IncludeProjectName>
        <Type>Content</Type>
      </_FilesForSharedProject>
    </ItemGroup>

    <!-- Pull in other custom content -->
    <ItemGroup>
      <ProjectItems Include="@(Content)" Condition="'%(Content.AddToProjectItems)' == 'true'" />
    </ItemGroup>

    <ItemGroup>
      <ProjectItems Include="@(_FilesForSharedProject->Distinct())" Condition="'$(UseProjectNameWhenCollectingSharedContent)' == 'false' Or $([System.String]::Copy('%(RecursiveDir)').Contains($(WebProjectName)))">
        <Link>%(_FilesForSharedProject.Link)%(_FilesForSharedProject.RecursiveDir)%(_FilesForSharedProject.Filename)%(_FilesForSharedProject.Extension)</Link>
      </ProjectItems>
    </ItemGroup>

  </Target>


  <Target Name="WriteContentFile"
          Condition="'$(OutputSharedWebContentFile)' == 'true'"
          AfterTargets="AfterBuild"
          DependsOnTargets="CollectSharedProjectItems">

    <WriteSharedContentFile
      OutputFile="$(MSBuildProjectFullPath).shared"
      PathPropertyName="$(MSBuildProjectName.Replace('.', ''))Path"
      ProjectRootDirectory="$(ScriptsDirectory)"
      ProjectItems="@(ProjectItems)" />

    <ItemGroup>
      <!-- Remove items which we will never again use - they just sit around taking up memory otherwise -->
      <ProjectItems Remove="@(ProjectItems)" />
    </ItemGroup>

  </Target>


  <Target Name="CollectLinkedContentFiles" BeforeTargets="CopyLinkedContentFiles" Returns="@(ContentToCopy)">
    <ItemGroup>
      <ContentToCopy Include="@(Content->HasMetadata('Link'))">
        <OriginalItemSpec>%(FullPath)</OriginalItemSpec>
      </ContentToCopy>

      <ContentToCopy Include="@(TypeScriptCompile->HasMetadata('Link'))">
        <OriginalItemSpec>%(FullPath)</OriginalItemSpec>
      </ContentToCopy>
    </ItemGroup>
  </Target>


  <!-- Maintains the  F5 experience -->
  <Target Name="CopyLinkedContentFiles"
          DependsOnTargets="CollectLinkedContentFiles"
          BeforeTargets="PreComputeCompileTypeScript;Build;CopyAllFilesToSingleFolderForMsdeploy"
          Inputs="@(ContentToCopy)"
          Outputs="@(ContentToCopy->'$(MSBuildProjectDirectory)\%(Link)')">

    <!-- Only copy files with the Link attribute set -->
    <Copy SourceFiles="@(ContentToCopy->'%(OriginalItemSpec)')"
          DestinationFiles="@(ContentToCopy->'$(MSBuildProjectDirectory)\%(Link)')"
          SkipUnchangedFiles="true"
          OverwriteReadOnlyFiles="true"
          UseHardlinksIfPossible="true" />

    <ItemGroup>
      <!-- Remove items which we will never again use - they just sit around taking up memory otherwise -->
      <ContentToCopy Remove="@(ContentToCopy)" />
    </ItemGroup>

  </Target>


  <ItemGroup>
    <!--Exclude any .less files beginning with an '_' from being compiled as a convention, also exclude all less files from the obj directories -->
    <LessFiles Include="$(MSBuildProjectDirectory)\Content\*.less"
               Exclude="$(MSBuildProjectDirectory)\Content\_*.less" />
  </ItemGroup>


  <Target Name="CompileLess"
          Inputs="@(LessFiles)"
          Outputs="@(LessFiles->'%(RelativeDir)%(Filename).css')"
          AfterTargets="CopyLinkedContentFiles"
          Condition="'$(EnableLESSCompile)' == 'True'">

    <CompileLess LessFiles="@(LessFiles)" />

  </Target>

  <Target Name="custom-tsconfig-->tsc"
          Condition="'$(BuildingInsideVisualStudio)' != 'true'"
          AfterTargets="CompileTypeScriptWithTSConfig">

    <ItemGroup>
      <CustomTSConfigs
        Include="$(MSBuildProjectDirectory)\**\*custom.tsconfig.json"
        Exclude="$(MSBuildProjectDirectory)\**\PackageTmp\**;
                 $(MSBuildProjectDirectory)\**\obj\**;
                 $(MSBuildProjectDirectory)\**\bin\**;"/>
    </ItemGroup>

    <Exec Condition="'@(CustomTSConfigs)' != ''"
          Command="&quot;$(MSBuildProgramFiles32)\Microsoft SDKs\TypeScript\$(TypeScriptToolsVersion)\tsc.exe&quot; --project %(CustomTSConfigs.FullPath)"
          YieldDuringToolExecution="true" />
  </Target>


</Project>