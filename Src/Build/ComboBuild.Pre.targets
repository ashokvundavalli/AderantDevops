<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="Build"
         ToolsVersion="14.0"
         TreatAsLocalProperty="SolutionDirectoryPath">
  
  <Import Project="Aderant.Build.Common.targets" />
  <Import Project="RM.TransformTemplates.Targets" />
  <Import Project="Aderant.TextTransform.targets" />
  <Import Project="Aderant.Build.CustomSolutionPackaging.targets" />
  <Import Project="Aderant.Build.Clean.targets" />

  <!-- Entry target -->
  <Target Name="Build" DependsOnTargets="$(RunBuildDependsOn)">
  </Target>

  <PropertyGroup>
    <RunBuildDependsOn>
      _BeforeBuild;
      ValidateRequiredProperties;
      CleanBin;
      PrepareZipCustomSource;
      ZipCustomSource;
      DeployPerDirectoryFiles;
      SetBuildNumbers;
      UpdateCommonAssemblyInfo;
      SeedPackagePacking;
      ZipWorkflowTemplateSource;
      GetDependencies;
      rmTransformTemplates;
      UpdateVariableBag
    </RunBuildDependsOn>
  </PropertyGroup>


  <PropertyGroup>
    <BuildProperties Condition="'$(IsWebModule)' == 'true'">$(BuildProperties);WebPublishPipelineCustomizeTargetFile=$(MSBuildThisFileDirectory)\Aderant.wpp.targets;</BuildProperties>

    <ModuleBuildTempDirectory Condition="'$(ModuleBuildTempDirectory)' == ''">$(SolutionDirectoryPath)BuildTemp\</ModuleBuildTempDirectory>
    <rmBCItemTransformTemplatesEnabled>$(T4TransformEnabled)</rmBCItemTransformTemplatesEnabled>
    <TfvcDropLocation>\\dfs.aderant.com\expertsuite\dev\vnext</TfvcDropLocation>
    <CleanBin Condition="'$(CleanBin)' == ''">false</CleanBin>
  </PropertyGroup>


  <!--     
    Configures the environment to run text templates       
  -->
  <Target Name="rmBeforeTransformTemplates">
    <PropertyGroup>
      <rmT4AssemblyReferencePaths>$(SolutionDirectoryPath)Dependencies\</rmT4AssemblyReferencePaths>
      <rmT4AssemblyReferencePaths Condition="Exists('$(OutDir)')">$(rmT4AssemblyReferencePaths);$(OutDir);</rmT4AssemblyReferencePaths>
    </PropertyGroup>

    <ItemGroup>
      <!-- __*.tt is special convention which we ignore. Underscore underscore template are transformed by some other process 
           crafted by the developer -->
      <rmT4TextTemplates Condition="('$(ModuleName)' != 'Libraries.SoftwareFactory')"
        Include="$(ModuleSourceDirectory)**\*.tt;
                 $(ModuleTestDirectory)**\*.tt;"
        Exclude="$(ModuleSourceDirectory)**\__*.tt;
                 $(ModuleSourceDirectory)**\obj\**\*.tt;
                 $(ModuleTestDirectory)**\obj\**\*.tt;
                 $(ModuleSourceDirectory)**\PackageTmp\**\*.tt">
        <Generator>TextTemplatingFileGenerator</Generator>
      </rmT4TextTemplates>
    </ItemGroup>

    <ItemGroup>
      <TemplateExclude Include="$(ModuleSourceDirectory)**\Aderant.Framework.SmartForm.Dsl\**\*.tt" />
    </ItemGroup>

    <ItemGroup>
      <rmT4TextTemplates Remove="@(TemplateExclude)" />
    </ItemGroup>

    <Message Text="IsDesktopBuild: $(IsDesktopBuild)" />
    <Message Text="SolutionDirectoryPath: $(SolutionDirectoryPath)" />
    <Message Text="ModuleSourceDirectory: $(ModuleSourceDirectory)" />
    <Message Text="ModuleTestDirectory: $(ModuleTestDirectory)" />

    <Message Text="" />
    <Message Text="DSLDirectiveLoadMethod: $(DSLDirectiveLoadMethod)" />
    <Message Text="AderantBuildClientTasksV100Lib-1_0_0_0: $(AderantBuildClientTasksV100Lib-1_0_0_0)" />
    <Message Text="rmT4AssemblyReferencePaths: $(rmT4AssemblyReferencePaths)" />
    <Message Text="rmT4TextTemplates: @(rmT4TextTemplates)" />
  </Target>

  <Target Name="_BeforeBuild">
    <Message Text="
╔═════════════════════════════════════════════════════════════════════╗
║                     $(ModuleName.PadRight(26))                      ║
╚═════════════════════════════════════════════════════════════════════╝
" Importance="high" />

  </Target>

  <Target Name="ValidateRequiredProperties">
    <Error Condition="'$(SolutionRoot)' == ''" Text="SolutionRoot is undefined." />
    <Error Condition="'$(CustomAfterMicrosoftCSharpTargets)' == '' And '$(IsCustomBuild)' != 'true'" Text="No custom CSharp targets file set." />
    <Error Condition="'$(CustomAfterMicrosoftCommonTargets)' == '' And '$(IsCustomBuild)' != 'true'" Text="No custom Microsoft common targets file set." />
  </Target>



  <Target Name="GetDependencies" Condition="'$(SolutionRoot)' != ''">
    <GetDependencies Condition="'$(UseSharedDependencyDirectory)' != 'true'"
      ProductManifest="$(ProductManifestPath)"
      ModulesRootPath="$(SolutionRoot)"
      ModuleName="$(ModuleName)"
      BuildType="ContinuousIntegration"
      DependenciesDirectory="$(DependenciesDirectory)"
      DropPath="$(TfvcDropLocation)" />

  </Target>

  <Target Name="DeployPerDirectoryFiles" Condition="'$(SolutionRoot)' != ''">

    <Message Text="SolutionDirectoryPath: $(SolutionDirectoryPath)" />
    <Message Text="T4TransformEnabled:    $(T4TransformEnabled)" />
    <Message Text="ZipCustomSource:       $(ZipCustomSource)" />
    <Message Text="VersionMajor:          $(VersionMajor)" />
    <Message Text="VersionMinor:          $(VersionMinor)" />
    <Message Text="VersionBuild:          $(VersionBuild)" />
    <Message Text="VersionRevision:       $(VersionRevision)" />

    <ItemGroup>
      <DirProject Include="$(MSBuildThisFileDirectory)\dir.proj;
                           $(MSBuildThisFileDirectory)\Aderant.wpp.content.proj;
                           $(MSBuildThisFileDirectory)\Aderant.wpp.content.v2.proj" />
    </ItemGroup>

    <Copy SourceFiles="@(DirProject)"
      DestinationFolder="$(SolutionRoot)"
      UseHardlinksIfPossible="true"
      OverwriteReadOnlyFiles="true"
      SkipUnchangedFiles="true" />

  </Target>

  <!--
    ==========================================================================================
        Versioning 
    ==========================================================================================
  -->
  <Target Name="UpdateCommonAssemblyInfo"
          Condition="'$(IsDesktopBuild)' == 'false'" DependsOnTargets="SetBuildNumbers">

    <PropertyGroup>
      <AssemblyInfoFile>$(ModuleBuildDirectory)CommonAssemblyInfo.cs</AssemblyInfoFile>
    </PropertyGroup>

    <FileUpdate
      Files="$(AssemblyInfoFile)"
      IgnoreCase="true"
      Multiline="true"
      Singleline="false"
      Regex="(?&lt;section1&gt;AssemblyFileVersion\(\&quot;)(?&lt;version&gt;[0-9]*.[0-9]*.[0-9]*.[0-9]*)(?&lt;section2&gt;\&quot;\))"
      ReplacementText="${section1}$(FileVersion)${section2}" />

  </Target>


  <Target Name="UpdateVariableBag">

    <PropertyGroup>
      <FileVersion Condition="'$(FileVersion)' == ''">1.0.0.0</FileVersion>
      <AssemblyVersion Condition="'$(AssemblyVersion)' == ''">1.8.0.0</AssemblyVersion>
    </PropertyGroup>

    <UpdateVariableBag
      Id="$(VariableBagId)"
      ContextFileName="$(ContextFileName)"
      FileVersion="$(FileVersion)"
      AssemblyVersion="$(AssemblyVersion)"
      ModuleName="$(ModuleName)" />

  </Target>

</Project>
