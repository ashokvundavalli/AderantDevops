<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="14.0">
<!-- External variables: ArtifactStagingDirectory, BuildToolsDirectory, ExpertSourceDirectory, SolutionRoot, ServerImageDependencyMappings -->

  <PropertyGroup>
    <CreateServerImageDependsOn>
      GetFilesForPackage;
      GetServerImageDependencies;
    </CreateServerImageDependsOn>

    <ImageWorkingDirectory>$(ArtifactStagingDirectory)ServerImage\</ImageWorkingDirectory>
    <ImageToolingDirectory>$(ImageWorkingDirectory)packages\Aderant.Deployment.Internal\lib\</ImageToolingDirectory>
    <DeploymentEngine>$(ImageWorkingDirectory)packages\Aderant.Deployment.Internal\lib\DeploymentEngine.exe</DeploymentEngine>

    <_CreateServerImage Condition="'$(IsDesktopBuild)' == 'true'">false</_CreateServerImage>
    <_CreateServerImage Condition="'$(_CreateServerImage)' == ''">$([System.Environment]::GetEnvironmentVariable('CreateServerImage'))</_CreateServerImage>
    <_CreateServerImage Condition="'$(_CreateServerImage)' == ''">$([MSBuild]::ValueOrDefault('$(CreateServerImage)', 'false'))</_CreateServerImage>
  </PropertyGroup>


  <Target Name="GetServerImageDependencies" Condition="'@(ServerImageDependencyMappings)' != ''">

    <GeneratePaketDependencies OutputDirectory="$(ImageWorkingDirectory)"
      ExpertManifest="$(SolutionRoot)Build\ExpertManifest.xml"
      DependencyMappings="@(ServerImageDependencyMappings)" />

    <Exec Command="$(BuildToolsDirectory)paket.exe update"
      WorkingDirectory="$(ImageWorkingDirectory)" />

  </Target>


  <Target Name="CreateServerImageCore" BeforeTargets="CreateServerImage">
    <!-- Initializes PropertyGroup variables. -->
  </Target>


  <Target Name="CreateServerImage" Condition="'$(_CreateServerImage)' == 'true'" DependsOnTargets="CreateServerImageCore;$(CreateServerImageDependsOn)">

    <PropertyGroup>
      <_SkipHelp Condition="'$(SkipHelp)' != 'false'">/skh</_SkipHelp>
      <_SkipDownloadsFolder Condition="'$(SkipDownloadsFolder)' != 'false'">/skipdownloadsfolder</_SkipDownloadsFolder>
    </PropertyGroup>

    <Exec Command="&quot;$(DeploymentEngine)&quot; CreateServerImage /source:$(ExpertSourceDirectory) /image:$(ImageWorkingDirectory) /name:ExpertServerImage $(_SkipHelp) $(_SkipDownloadsFolder)" />

    <ItemGroup>
      <AdditionalArtifacts Condition="'$(IsDesktopBuild)' != 'true'" Include="$(ImageWorkingDirectory)ExpertServerImage.zip">
        <ArtifactId>ExpertServerImage</ArtifactId>
        <ArtifactType>Branch</ArtifactType>
      </AdditionalArtifacts>
    </ItemGroup>

  </Target>

  
</Project>