<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="RunBuildForGroup"
         ToolsVersion="14.0"
         TreatAsLocalProperty="SolutionDirectoryPath">
  
  <Import Project="$(InstanceProjectFile)" />
  <Import Project="Aderant.Build.Common.targets" />
  <Import Project="RM.TransformTemplates.Targets" />
  <Import Project="Aderant.TextTransform.targets" />
  <Import Project="Aderant.Build.CustomSolutionPackaging.targets" />
  <Import Project="Aderant.Build.Clean.targets" />

  <PropertyGroup>
    <RunBuildDependsOn>
      
      ValidateRequiredProperties;
      CleanBin;
      PrepareZipCustomSource;
      ZipCustomSource;
      DeployPerDirectoryFiles;
      <!--GetDependencies;-->
      rmTransformTemplates;
    </RunBuildDependsOn>

    <InitializeModuleBuildDependsOn>
      SetBuildNumbers;
      UpdateModuleFileVersion;
      SeedPackagePacking;
      ZipWorkflowTemplateSource;
    </InitializeModuleBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <BinTestDirectory>$(SolutionDirectoryPath)Bin\Test\</BinTestDirectory>
    <BinModuleDirectory>$(SolutionDirectoryPath)Bin\Module\</BinModuleDirectory>
    <ModuleSourceDirectory>$(SolutionDirectoryPath)Src\</ModuleSourceDirectory>
    <ModuleTestDirectory>$(SolutionDirectoryPath)Test\</ModuleTestDirectory>
    <ModuleBuildDirectory>$(SolutionDirectoryPath)Build\</ModuleBuildDirectory>
    <DependenciesDirectory>$(SolutionDirectoryPath)Dependencies</DependenciesDirectory>
    <ModuleBuildTempDirectory Condition="'$(ModuleBuildTempDirectory)' == ''">$(SolutionDirectoryPath)BuildTemp\</ModuleBuildTempDirectory>
    <rmBCItemTransformTemplatesEnabled>$(T4TransformEnabled)</rmBCItemTransformTemplatesEnabled>
    <TfvcDropLocation>\\dfs.aderant.com\expertsuite\dev\vnext</TfvcDropLocation>
    <CleanBin Condition="'$(CleanBin)' == ''">false</CleanBin>
  </PropertyGroup>

  <!-- Entry target -->
  <Target Name="Build" DependsOnTargets="RunBuildForGroup" />

  <Target Name="ValidateRequiredProperties">
    <!--<Error Condition="'$(SolutionDirectoryPath)' == ''" Text="SolutionDirectoryPath is undefined" />-->
    <Error Condition="'$(CustomAfterMicrosoftCSharpTargets)' == '' And '$(IsCustomBuild)' != 'true'" Text="No custom CSharp targets file set" />
    <Error Condition="'$(CustomAfterMicrosoftCommonTargets)' == '' And '$(IsCustomBuild)' != 'true'" Text="No custom Microsoft common targets file set" />
  </Target>

  <Target Name="RunBuildForGroup" DependsOnTargets="$(RunBuildDependsOn)">
    <Message Importance="Low" Text="MSBuildNodeCount: $(MSBuildNodeCount)"/>
    <Message Importance="Low" Text="MSBuildExtensionsPath32: $(MSBuildExtensionsPath32)"/>
    <Message Importance="Low" Text="MSBuildProjectDirectoryNoRoot: $(MSBuildProjectDirectoryNoRoot)"/>
    <Message Importance="Low" Text="MSBuildToolsPath: $(MSBuildToolsPath)"/>
    <Message Importance="Low" Text="MSBuildToolsVersion: $(MSBuildToolsVersion)"/>
    <Message Importance="Low" Text="MSBuildBinPath: $(MSBuildBinPath)"/>
    <Message Importance="Low" Text="MSBuildExtensionsPath: $(MSBuildExtensionsPath)"/>
    <Message Importance="Low" Text="MSBuildProjectDefaultTargets: $(MSBuildProjectDefaultTargets)"/>
    <Message Importance="Low" Text="MSBuildProjectDirectory: $(MSBuildProjectDirectory)"/>
    <Message Importance="Low" Text="MSBuildProjectExtension: $(MSBuildProjectExtension)"/>
    <Message Importance="Low" Text="MSBuildProjectFile: $(MSBuildProjectFile)"/>
    <Message Importance="Low" Text="MSBuildProjectFullPath: $(MSBuildProjectFullPath)"/>
    <Message Importance="Low" Text="MSBuildProjectName: $(MSBuildProjectName)"/>
    <Message Importance="Low" Text="MSBuildStartupDirectory: $(MSBuildStartupDirectory)"/>

    <!-- From the generated project, find projects we should build in this group. -->
    <ItemGroup>
      <BuildGroup Include="@(AllProjectsToBuild->WithMetadataValue('BuildGroup', '$(BuildGroup)'))" /> 
    </ItemGroup>

    <PropertyGroup>
      <IsWebModule>false</IsWebModule>
      <IsWebModule Condition="$(ModuleName.Contains('Web.')) Or '$(PackageWeb)' == 'true'">true</IsWebModule>
      <ExternalConstants Condition="'$(IsCustomBuild)' == 'true'">IS_CUSTOM_BUILD</ExternalConstants>
    </PropertyGroup>

    <PropertyGroup>
      <AssemblyDebugOptions>
        DebugSymbols=true;
        DebugType=full;
        Optimize=true
      </AssemblyDebugOptions>
    </PropertyGroup>

    <PropertyGroup>
      <BuildProperties>
        BuildToolsDirectory=$(BuildToolsDirectory);
        BuildScriptsDirectory=$(BuildScriptsDirectory);
        CustomAfterMicrosoftCSharpTargets=$(CustomAfterMicrosoftCSharpTargets);
        CustomAfterMicrosoftCommonTargets=$(CustomAfterMicrosoftCommonTargets);
        AlternativeOutputDirectory=$(SharedDependencyDirectory);
        ShouldUnsetParentConfigurationAndPlatform=true;
        BuildProjectReferences=false;
        <!--$(AssemblyDebugOptions)-->
      </BuildProperties>
      
      <BuildProperties Condition="'$(IsWebModule)' == 'true'">$(BuildProperties);WebPublishPipelineCustomizeTargetFile=$(MSBuildThisFileDirectory)\Aderant.wpp.targets;</BuildProperties>
    </PropertyGroup>

    <PropertyGroup>
      <OrchestrationProperties>
        SolutionDirectoryPath=$(SolutionDirectoryPath);
        BinTestDirectory=$(BinTestDirectory);
        BinModuleDirectory=$(BinModuleDirectory);
        ModuleSourceDirectory=$(ModuleSourceDirectory);
        ModuleTestDirectory=$(ModuleTestDirectory);
        ModuleBuildDirectory=$(ModuleBuildDirectory)
      </OrchestrationProperties>
  </PropertyGroup>

    <!--
        ShouldUnsetParentConfigurationAndPlatform
        Ensures that x86 projects with a P2P reference to an AnyCPU project don't push the x86 configuration/platform into the P2P reference and trigger
        a missing configuration/platform error.
    -->

    <Message Text="
╔═════════════════════════════════════════════════════════════════════╗
║                     Group $(BuildGroup.PadRight(4)) / $(TotalNumberOfBuildGroups.PadRight(34)) ║
╚═════════════════════════════════════════════════════════════════════╝
" Importance="high"></Message>

  <PropertyGroup>
    <ProjectsToBuildItemGroup>ProjectsToBuild$(BuildGroup)</ProjectsToBuildItemGroup>
  </PropertyGroup>

    <ItemGroup>
      <!-- <Projects Include="@(ProjectsInGroup)" Condition="'%(ProjectsInGroup.IsOrchestrationParticipant)' == 'true'"> -->
        <!-- <Properties>%(Projects.Properties);$(BuildProperties);$(OrchestrationProperties)</Properties> -->
      <!-- </Projects> -->
      
      
      <Projects Include="$(ProjectsToBuildItemGroup)"/>

      <!--<Projects Include="@(ProjectsInGroup)" Condition="'%(ProjectsInGroup.IsWebProject)' == 'true'">
        <Properties>%(Projects.Properties);$(BuildProperties);PackageWeb=true</Properties>
      </Projects>

      <Projects Include="@(ProjectsInGroup)" Condition="'%(ProjectsInGroup.IsWebProject)' != 'true'">
        <Properties>%(Projects.Properties);$(BuildProperties)</Properties>
      </Projects>-->
    </ItemGroup>

    <InspectItemGroup ItemGroup="@(Projects)" />

    <MSBuild Condition="'%(FileName)' != '$(MSBuildThisFileName)' And '%(Extension)' != '.csproj'"
             Projects="@(Projects)"
             Targets="Build"
             BuildInParallel="true"
             Properties="%(Projects.Properties)">
      <!--The compiled assemblies from projects-->
      <Output ItemName="CompiledAssemblies"
              TaskParameter="TargetOutputs" />
    </MSBuild>

  </Target>

  <Target Name="GetDependencies" Condition="'$(SolutionRoot)' != ''">

    <Message Text="
╔═════════════════════════════════════════════════════════════════════╗
║                     $(ModuleName.PadRight(26))                      ║
╚═════════════════════════════════════════════════════════════════════╝
" Importance="high" />

    <GetDependencies Condition="'$(UseSharedDependencyDirectory)' != 'true'"
      ProductManifest="$(ProductManifestPath)"
      ModulesRootPath="$(SolutionRoot)"
      ModuleName="$(ModuleName)"
      BuildType="ContinuousIntegration"
      DependenciesDirectory="$(DependenciesDirectory)"
      DropPath="$(TfvcDropLocation)" />

  </Target>

  <Target Name="DeployPerDirectoryFiles" Condition="'$(SolutionRoot)' != ''">

    <Message Text="SolutionDirectoryPath: $(SolutionDirectoryPath)" />
    <Message Text="T4TransformEnabled:    $(T4TransformEnabled)" />
    <Message Text="ZipCustomSource:       $(ZipCustomSource)" />
    <Message Text="VersionMajor:          $(VersionMajor)" />
    <Message Text="VersionMinor:          $(VersionMinor)" />
    <Message Text="VersionBuild:          $(VersionBuild)" />
    <Message Text="VersionRevision:       $(VersionRevision)" />

    <ItemGroup>
      <DirProject Include="$(MSBuildThisFileDirectory)\dir.proj;
                           $(MSBuildThisFileDirectory)\Aderant.wpp.content.proj;
                           $(MSBuildThisFileDirectory)\Aderant.wpp.content.v2.proj" />
    </ItemGroup>

    <Copy SourceFiles="@(DirProject)"
      DestinationFolder="$(SolutionRoot)"
      UseHardlinksIfPossible="true"
      OverwriteReadOnlyFiles="true"
      SkipUnchangedFiles="true" />

  </Target>

  <!--
    ==========================================================================================
        Versioning 
    ==========================================================================================
  -->
  <Target Name="UpdateModuleFileVersion"
      Condition="'$(BUILD_BUILDURI)' != ''">

    <PropertyGroup>
      <AssemblyInfoFile>$(ModuleBuildDirectory)CommonAssemblyInfo.cs</AssemblyInfoFile>
    </PropertyGroup>

    <FileUpdate Files="$(AssemblyInfoFile)"
        IgnoreCase="true"
        Multiline="true"
        Singleline="false"
        Regex="(?&lt;section1&gt;AssemblyFileVersion\(\&quot;)(?&lt;version&gt;[0-9]*.[0-9]*.[0-9]*.[0-9]*)(?&lt;section2&gt;\&quot;\))"
        ReplacementText="${section1}$(FileVersion)${section2}" />

  </Target>

</Project>
