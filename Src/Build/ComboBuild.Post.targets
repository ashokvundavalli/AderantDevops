<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="Build"
         ToolsVersion="14.0">

  <Import Project="Aderant.Build.Common.targets" />
  <Import Project="Aderant.Build.CopyToDropV2.targets" />
  <Import Project="Aderant.Build.Testing.targets" />
  <Import Project="Aderant.Build.IntegrationTesting.targets" />
  <Import Project="Aderant.Build.Publish.targets" />
  <Import Project="Aderant.CodeSigning.targets" />
  <Import Project="Mobile.targets" />

  <PropertyGroup>
    <CopyToDropV2 Condition="'$(CopyToDropV2)' == '' And '$(IsDesktopBuild)' == 'true'">false</CopyToDropV2>

    <!-- TODO: Enable...currently off for perf reasons-->
    <CodeCoverage>false</CodeCoverage>
  </PropertyGroup>

  <UsingTask TaskName="Aderant.Build.Tasks.GetAssemblyPlatform"
    AssemblyFile="$(BuildAssembly)"
    Condition="'$(IsCustomBuild)' != 'true'" />

  <!--
    ==========================================================================================
        Test Configuration
    ==========================================================================================
  -->
  <PropertyGroup>
    <RunTestsDependsOn>
      $(RunTestsDependsOn);
      CollectTestAssemblies;
    </RunTestsDependsOn>

    <AfterBuildDependsOn>
      ValidateRequiredProperties;
      OpenVariableBag;
      <!--RunTests;
      RunIntegrationTests;
      --><!--RunAutomationTests;--><!--
      PublishModule;
      IndexSourcesAndPublishSymbols;
      MobileBuild;
      PostBuild;
      SignInstallers;-->
      PackageArtifactsCore;
    </AfterBuildDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <PackageArtifactsDependsOn>
      $(PackageArtifactsDependsOn);
      PackageArtifacts
    </PackageArtifactsDependsOn>
  </PropertyGroup>

  <!--Stub.-->
  <Target Name="PackageArtifacts" />


  <Target Name="OpenVariableBag">
    <UpdateVariableBag
      Id="$(VariableBagId)"
      ContextFileName="$(ContextFileName)"
      Output="true">
      <Output TaskParameter="FileVersion" PropertyName="FileVersion" />
      <Output TaskParameter="AssemblyVersion" PropertyName="AssemblyVersion" />
      <Output TaskParameter="ModuleName" PropertyName="ModuleName" />
    </UpdateVariableBag>

  </Target>


  <Target Name="PackageArtifactsCore" DependsOnTargets="$(PackageArtifactsDependsOn)">

    <PublishArtifacts
      ContextFileName="$(ContextFileName)"
      SolutionRoot="$(SolutionRoot)"
      RelativeFrom="$(BinModuleDirectory);$(BinTestDirectory)"
      Artifacts="@(PackageArtifact)"
      AssemblyVersion="$(AssemblyVersion)"
      FileVersion="$(FileVersion)" />

  </Target>


  <Target Name="CollectTestAssemblies">

    <ItemGroup>
      <TestAssemblies
        Include="$(BinTestDirectory)*UnitTest*.dll;
                 $(BinTestDirectory)*.Tests.ps1;"
        Exclude="$(BinTestDirectory)*Helpers*.dll;
                 $(BinTestDirectory)Microsoft.*" />
      <IntegrationTestAssemblies Include="$(BinTestDirectory)*IntegrationTest*.dll" />
    </ItemGroup>

    <ItemGroup>
      <AssembliesToAnalyze Include="@(ModuleBuildOutput)" Condition="'%(ModuleBuildOutput.OutputType)' == 'Module'" />
      <AssembliesToAnalyze Include="@(BuildOutput)" />
    </ItemGroup>

    <!-- Determine if we can run the tests using the 64-bit test runner -->
    <GetAssemblyPlatform
      Condition="'$(Use32BitTestRunner)' == ''"
      Assemblies="@(AssembliesToAnalyze)">
      <Output ItemName="AssemblyList" TaskParameter="Assemblies" />
      <Output PropertyName="Use32BitTestRunner" TaskParameter="MustRun32Bit" />
    </GetAssemblyPlatform>

    <Message Text="Assembly: %(AssemblyList.FileName) [Platform: %(AssemblyList.Platform)]" Condition="'@(AssemblyList)' != ''" />

    <!-- 
      This section creates a .dll.config for each unit test assembly. The dll.config contains a probing path override 
      which includes two additional folders "ModuleBin" and "Dependencies". This is so unit tests can find dependencies
      without relying on copy local having deployed assemblies to the test directory.
    -->
    <PropertyGroup>
      <UnitTestAppConfigText>$([System.IO.File]::ReadAllText('$(BuildScriptsDirectory)UnitTestAppConfig.txt'))</UnitTestAppConfigText>
    </PropertyGroup>

    <ItemGroup>
      <TestAssemblyConfigFiles Include="@(TestAssemblies->'$(BinTestDirectory)%(RecursiveDir)%(Filename)%(Extension).config')" />
    </ItemGroup>

    <Touch Condition="!Exists(%(TestAssemblyConfigFiles.FullPath))"
      Files="%(TestAssemblyConfigFiles.FullPath)"
      AlwaysCreate="true">
      <Output TaskParameter="TouchedFiles" ItemName="TouchedFiles" />
    </Touch>

    <ItemGroup>
      <XmlLinesToWrite Include="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;" />
      <XmlLinesToWrite Include="&lt;configuration /&gt;" />
    </ItemGroup>

    <WriteLinesToFile Condition="'@(TouchedFiles)' != ''"
      File="%(TouchedFiles.FullPath)"
      Lines="@(XmlLinesToWrite)"
      Encoding="UTF-8" />

    <Error Condition="'$(UnitTestAppConfigText)' == ''" Text="No unit test app.config text defined!" />

    <XDocumentPoke Condition="Exists(%(TestAssemblyConfigFiles.FullPath))"
      File="%(TestAssemblyConfigFiles.FullPath)"
      Query="configuration/runtime"
      Value="$(UnitTestAppConfigText)" />

    <MakeSymlink Condition="'@(TestAssemblies)' != '' And Exists('$(DependenciesDirectory)')"
      Link="$(BinTestDirectory)Dependencies"
      Target="$(DependenciesDirectory)" />

    <MakeSymlink Condition="'@(TestAssemblies)' != '' And '$(IsWebModule)' != 'true'"
      Link="$(BinTestDirectory)ModuleBin"
      Target="$(BinModuleDirectory)" />
  </Target>

  <!-- Stub for customizers to override -->
  <Target Name="PostBuild" />

  <!-- Pull the entry targets into our context. This lets us call into PostBuild for people who want to customize the workflow -->
  <Import Project="$(SolutionDirectoryPath)Build\TFSBuild.proj" Condition="Exists('$(SolutionDirectoryPath)Build\TFSBuild.proj')" />


  <Target Name="Build" DependsOnTargets="AfterBuild">
  </Target>


  <Target Name="AfterBuild" DependsOnTargets="$(AfterBuildDependsOn)">
  </Target>


  <Target Name="ValidateRequiredProperties">
    <Error Condition="'$(SolutionDirectoryPath)' == ''" Text="SolutionDirectoryPath is undefined" />
  </Target>


  <Target Name="OnTestFailure">
    <CallTarget Targets="AfterRunTests;CopyTrxFile;MarkBuildStepAsFailed"/>
  </Target>


  <Target Name="AfterRunTests"
    AfterTargets="RunTests">

    <RemoveDir Directories="$(BinTestDirectory)Dependencies"
      ContinueOnError="true"  />
    <RemoveDir Directories="$(BinTestDirectory)ModuleBin"
      ContinueOnError="true" />
    <RemoveDir Directories="$(BinTestDirectory)TestResults\packages"
      ContinueOnError="true" />

    <Delete Condition="'@(TestAssemblyConfigFiles)' != ''"
      Files="@(TestAssemblyConfigFiles)"
      TreatErrorsAsWarnings="true" />
  </Target>


  <Target Name="CopyTrxFile" AfterTargets="RunTests">
    <!--<ItemGroup>
      <TestResults Include="$(SolutionDirectoryPath)**\*.trx" />
    </ItemGroup>

    <Copy Condition="@(TestResults) != ''"
          SourceFiles="@(TestResults)"
          DestinationFiles="$(BinTestDirectory)TestResults.trx" />-->
  </Target>


  <Target Name="CopyToDrop">

    <!--Shim: Just blat the drop location with the staging directory-->
    <PropertyGroup>
      <DropLocation>$(ArtifactStagingDirectory)</DropLocation>
    </PropertyGroup>

    <!--We have differing ways of determining the drop location depending on the type of build. 
        The simplest way was to have a condition on whether we are build all modules of a single module.-->
    <PropertyGroup>
      <!--<DropLocation>C:\Temp\</DropLocation>
      <FileVersion>1.8.0.0</FileVersion>-->

      <ModuleDropLocation Condition="'$(BuildAll)' == 'true'">$(DropLocation)\$(ModuleName)\$(AssemblyVersion)\</ModuleDropLocation>
      <ModuleDropLocation Condition="'$(BuildAll)' != 'true'">$(DropLocation)\</ModuleDropLocation>
    </PropertyGroup>

    <WriteLinesToFile
      Condition="'@(ModuleBuildOutput)' != '' And '%(ModuleBuildOutput.OutputType)' == 'Module'"
      Lines="@(ModuleBuildOutput)"
      Overwrite="true"
      File="$(ModuleBuildTempDirectory)ModuleBinOutput.txt" />

    <WriteLinesToFile
      Condition="'@(ModuleBuildOutput)' != '' And '%(ModuleBuildOutput.OutputType)' == 'Test'"
      Lines="@(ModuleBuildOutput)"
      Overwrite="true"
      File="$(ModuleBuildTempDirectory)ModuleTestOutput.txt" />

    <PropertyGroup>
      <DropRootUncPathSwitch>-dropRootUNCPath $(ModuleDropLocation)</DropRootUncPathSwitch>
      <AssemblyFileVersionSwitch>-assemblyFileVersion $(FileVersion)</AssemblyFileVersionSwitch>
      <SuppressUniqueCheckSwitch Condition="'$(UseSharedDependencyDirectory)' == 'true'">-suppressUniqueCheck</SuppressUniqueCheckSwitch>
      <TestFailedSwitch Condition="'$(TestBreak)' == 'true'">-testBreak</TestFailedSwitch>
      <BuildBreakSwitch Condition="'$(BuildBreak)' == 'true'">-buildBreak</BuildBreakSwitch>
    </PropertyGroup>

    <PropertyGroup>
      <YieldDuringCopy Condition="'$(BuildAll)' != 'true'">false</YieldDuringCopy>
      <YieldDuringCopy Condition="'$(BuildAll)' == 'true'">true</YieldDuringCopy>
    </PropertyGroup>

    <Exec
      ContinueOnError="false"
      IgnoreExitCode="false"
      Command='"Powershell" -noprofile "$(BuildScriptsDirectory)CopyToDrop.ps1" -moduleName $(ModuleName) -moduleRootPath $(SolutionDirectoryPath) $(DropRootUncPathSwitch) $(AssemblyFileVersionSwitch) $(TestFailedSwitch) $(BuildBreakSwitch) $(SuppressUniqueCheckSwitch)'
      YieldDuringToolExecution="$(YieldDuringCopy)" />

    <!--At the moment we check for successful builds in the build logs where there are 0 Error(s). The BuildAll only has one build log
        so if we get this far we can assume the build is successfull so we create a dummy BuildLog   
    -->
    <MakeDir Directories="$(ModuleDropLocation)$(FileVersion)"
      Condition="('$(BuildAll)' == 'true' And !Exists('$(ModuleDropLocation)$(FileVersion)'))" />

    <WriteLinesToFile
      Condition="('$(BuildAll)'=='true')"
      File="$(ModuleDropLocation)$(FileVersion)\BuildLog.txt"
      Lines="Build succeeded via BuildAll - 0 Error(s)"/>

    <OnError ExecuteTargets="MarkBuildStepAsFailed" />

  </Target>



  <!--
    ==========================================================================================
        MarkBuildStepAsFailed
    ==========================================================================================
  -->
  <Target Name="MarkBuildStepAsFailed"
    Condition="'$(IsDesktopBuild)' != 'true' And '$(IsCustomBuild)' != 'true'">
    <Message Text="Marking build as failed" />

  </Target>

</Project>
