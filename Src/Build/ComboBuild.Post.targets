<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         DefaultTargets="Build"
         ToolsVersion="14.0">

  <Import Project="Aderant.Build.Common.targets" />
  <Import Project="Aderant.Build.Publish.targets" />
  <Import Project="Aderant.CodeSigning.targets" />
  <Import Project="Mobile.targets" />

  <PropertyGroup>
    <AutomaticallyPackageTests Condition="'$(AutomaticallyPackageTests)' == ''">true</AutomaticallyPackageTests>

    <PackageArtifacts Condition="'$(IsDesktopBuild)' == 'true'">false</PackageArtifacts>
    <PackageArtifacts Condition="'$(IsDesktopBuild)' == 'false'">true</PackageArtifacts>
  </PropertyGroup>

  <!--
    ==========================================================================================
        Test Configuration
    ==========================================================================================
  -->
  <PropertyGroup>
    <RunTestsDependsOn>
      $(RunTestsDependsOn);
      CollectTestAssemblies;
    </RunTestsDependsOn>

    <BuildCoreDependsOn>
      ValidateRequiredProperties;
      RefreshVersionVariables;
      <!--RunTests;
      RunIntegrationTests;
      --><!--RunAutomationTests;--><!--
      PublishModule;
      IndexSourcesAndPublishSymbols;
      MobileBuild;
      PostBuild;
      SignInstallers;-->
      PackageArtifactsCore;
      CreateDependencyLinks;
    </BuildCoreDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <PackageArtifactsDependsOn>
      $(PackageArtifactsDependsOn);
      CreateDefaultTestsArtifact;
      PackageArtifacts
    </PackageArtifactsDependsOn>
  </PropertyGroup>

  <!--Stub-->
  <Target Name="PackageArtifacts" />

  <Target Name="RefreshVersionVariables">

    <GetOrPutContextVariable
      Scope="$(VariableScopeId)"
      ContextEndpoint="$(ContextEndpoint)"
      Output="true">
      <Output TaskParameter="FileVersion" PropertyName="FileVersion" />
      <Output TaskParameter="AssemblyVersion" PropertyName="AssemblyVersion" />
      <Output TaskParameter="ModuleName" PropertyName="ModuleName" />
    </GetOrPutContextVariable>

    <Error Text="FileVersion is undefined" Condition="'$(FileVersion)' == '' And '$(IsDesktopBuild)' != 'true'" />

  </Target>


  <Target Name="CreateDefaultTestsArtifact" Condition="'$(AutomaticallyPackageTests)' == 'true'">
    <ItemGroup>
      <_PackageArtifact Include="$(BinTestDirectory)\**\*;">
        <ArtifactId>Tests.$(ModuleName)</ArtifactId>
        <Generated>true</Generated>
        <ArtifactType>Prebuilt</ArtifactType>
      </_PackageArtifact>
    </ItemGroup>
  </Target>


  <Target Name="PackageArtifactsCore" DependsOnTargets="$(PackageArtifactsDependsOn)">

    <CreateArtifacts
      ContextEndpoint="$(ContextEndpoint)"
      SolutionRoot="$(SolutionRoot)"
      RelativeFrom="$(BinModuleDirectory);$(BinTestDirectory)"
      ArtifactDefinitions="@(PackageArtifact);@(_PackageArtifact)"
      AssemblyVersion="$(AssemblyVersion)"
      FileVersion="$(FileVersion)" />

  </Target>


  <Target Name="CreateDependencyLinks">

    <CreateDependencyLinks 
      SolutionRoot="$(SolutionRoot)"
      ContextEndpoint="$(ContextEndpoint)" />
    
  </Target>
  

  <!-- Stub for customizers to override -->
  <Target Name="PostBuild" />


  <Target Name="Build" DependsOnTargets="BuildCore">
  </Target>


  <Target Name="BuildCore" DependsOnTargets="$(BuildCoreDependsOn)">
  </Target>


  <Target Name="ValidateRequiredProperties">
    <Error Condition="'$(SolutionDirectoryPath)' == ''" Text="SolutionDirectoryPath is undefined in $(ItemId)" />
  </Target>


  <!-- Pull the entry targets into our context. This lets us call into PostBuild for people who want to customize the workflow -->
  <Import Project="$(SolutionDirectoryPath)Build\TFSBuild.proj" Condition="Exists('$(SolutionDirectoryPath)Build\TFSBuild.proj')" />
  <Import Project="$(SolutionDirectoryPath)packaging.targets" Condition="Exists('$(SolutionDirectoryPath)packaging.targets')" />

</Project>
