<?xml version="1.0" encoding="utf-8"?>
<Project
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  ToolsVersion="12.0"
  DefaultTargets="PrepareBuildEnvironment"
  TreatAsLocalProperty="BuildScriptsDirectory">

  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" Condition="'$(MSBuildCommunityTasksLib)' == ''"/>

  <!-- Gets the platform of an assembly (e.g. x86, x64 or AnyCPU) -->
  <UsingTask TaskName="GetAssemblyPlatform"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <!-- Gets the dependencies for a given module -->
  <UsingTask TaskName="GetDependencies"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="MakeSymlink"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="DependencyChecker"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="BuildConfigurationCheck"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="FilterModules"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="AsyncExec"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="ExtractWebModule"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="GetCopyLocalItemsToRemove"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="ParallelBuildProjectFactory"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <!-- Adds SCC information into the pdb files for the symbol server -->
  <UsingTask TaskName="SourceIndex"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.Tasks.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <!-- Publishes pdb files to the symbol server -->
  <UsingTask TaskName="PublishSymbols"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.Tasks.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <PropertyGroup>
    <BuildScriptsDirectory Condition="'$(BuildScriptsDirectory)' == ''">$(MSBuildThisFileDirectory)\</BuildScriptsDirectory>
    
    <!-- Inject per CSharp project overrides. This target is imported once for each CSharp project and allows us access to project level variables -->
    <CustomAfterMicrosoftCSharpTargets Condition="'$(IsCustomBuild)' != 'true'">$(BuildScriptsDirectory)Aderant.CSharp.targets</CustomAfterMicrosoftCSharpTargets>
    <CustomAfterMicrosoftCommonTargets Condition="'$(IsCustomBuild)' != 'true'">$(BuildScriptsDirectory)Aderant.CustomAfterMicrosoftCommon.targets</CustomAfterMicrosoftCommonTargets>

    <BuildScriptsDirectory Condition="'$(BuildScriptsDirectory)' != '' And !HasTrailingSlash('$(BuildScriptsDirectory)')">$(BuildScriptsDirectory)\</BuildScriptsDirectory>
    <BuildToolsDirectory Condition="'$(BuildToolsDirectory)' == ''">$(BuildScriptsDirectory)..\Build.Tools\</BuildToolsDirectory>
    <BuildSourcesDirectory Condition="'$(BuildSourcesDirectory)' == ''">$(BuildScriptsDirectory)..\Sources\</BuildSourcesDirectory>
    <PrepareBuildEnvironmentTargetImported>true</PrepareBuildEnvironmentTargetImported>
  </PropertyGroup>

  <!--
    ==========================================================================================
      Prepare Build Environment
      Builds the Build.Infrastructure assemblies and tools required by the build process
    ==========================================================================================
  -->
  <Target Name="PrepareBuildEnvironment" Condition="'$(IsCustomBuild)' == 'true'">
    <!-- This is just a stub -->
  </Target>

  <Target Name="PrepareBuildEnvironment" Condition="'$(IsCustomBuild)' != 'true'">

    <Error Condition="'$(BuildScriptsDirectory)' == ''" Text="No value specified for BuildScriptsDirectory" />

    <Message Text="Setting up build environment from: $(BuildScriptsDirectory) in project $(MSBuildThisFileFullPath)" />

    <ItemGroup>
      <Projects Include="$(BuildSourcesDirectory)FxCopCmd\FxCopCmd.csproj"></Projects>
      <Projects Include="$(BuildSourcesDirectory)Aderant.Build\Aderant.Build.csproj"></Projects>
      <Projects Include="$(BuildSourcesDirectory)Aderant.Build.Tasks\Aderant.Build.Tasks.csproj"
                Condition="'$(IsDesktopBuild)' == 'false'" />
    </ItemGroup>

    <MSBuild
      Projects="@(Projects)"
      BuildInParallel="true"
      UnloadProjectsOnCompletion="true" />

    <ItemGroup>
      <CommunityTasksContent Include="$(BuildScriptsDirectory)Tasks\MSBuild.Community.Tasks\**\*" />
    </ItemGroup>

    <Message Text="Deploying MS Build Community Tasks" Condition="'$(IsDesktopBuild)' == 'false'" />
    <Copy Condition="'$(IsDesktopBuild)' == 'false'"
          SourceFiles="@(CommunityTasksContent)"
          DestinationFiles="@(CommunityTasksContent->'$(BuildToolsDirectory)%(RecursiveDir)%(Filename)%(Extension)')"
          OverwriteReadOnlyFiles="true"
          SkipUnchangedFiles="true"
          Retries="10"
          ContinueOnError="true" />

  </Target>

  <!--
    ==========================================================================================
        Version Numbers
    ==========================================================================================
  -->
  <Target Name="SetBuildNumbers"
          Condition="'$(IsDesktopBuild)' != 'true' And (('$(FileVersion)' == '' And '$(AssemblyVersion)' == '') Or '$(ForceVersion)' == 'true')">

    <PropertyGroup>
      <VersionMajor Condition="'$(VersionMajor)' == ''">1</VersionMajor>
      <VersionMinor Condition="'$(VersionMinor)' == ''">8</VersionMinor>
      <VersionBuild Condition="'$(VersionBuild)' == ''">0</VersionBuild>
      <VersionRevision Condition="'$(VersionRevision)' == ''">0</VersionRevision>
    </PropertyGroup>

    <Version BuildType="Automatic"
             RevisionType="Automatic"
             Major="$(VersionMajor)"
             Minor="$(VersionMinor)" >
      <Output TaskParameter="Major"
              PropertyName="Major" />
      <Output TaskParameter="Minor"
              PropertyName="Minor" />
      <Output TaskParameter="Build"
              PropertyName="Build" />
      <Output TaskParameter="Revision"
              PropertyName="Revision" />
    </Version>

    <PropertyGroup>
      <FileVersion>$(Major).$(Minor).$(Build).$(Revision)</FileVersion>
      <AssemblyVersion>$(VersionMajor).$(VersionMinor).$(VersionBuild).$(VersionRevision)</AssemblyVersion>
    </PropertyGroup>

    <Message Text="AssemblyVersion = $(AssemblyVersion)" />
    <Message Text="FileVersion = $(FileVersion)" />
  </Target>

  <!-- 
    ===========================================================
    Source Indexing properites 
    ===========================================================
  -->
  <PropertyGroup>
    <SymbolStore Condition="'$(SymbolStore)' == '' And '$(IsDesktopBuild)' == 'true'">C:\Temp\SymbolStore</SymbolStore>
    <SymbolStore Condition="'$(SymbolStore)' == '' And '$(IsDesktopBuild)' != 'true'">\\na.aderant.com\ExpertSuite\Symbols\</SymbolStore>

    <SymbolStoreLock Condition="'$(SymbolStoreLock)' == ''">$(SymbolStore)symstore.lock</SymbolStoreLock>

    <SymStorePath Condition="'$(WindowsSdkDir)' != '' And Exists('$(WindowsSdkDir)')">$(WindowsSdkDir)</SymStorePath>
    <SymStorePath Condition="'$(WindowsSDK80Path)' != '' And Exists('$(WindowsSDK80Path)')">$(WindowsSDK80Path)</SymStorePath>
    <SymStorePath Condition="'$(SymStorePath)' != ''">$(SymStorePath)Debuggers\x64\</SymStorePath>

    <OverwriteSymbolTextFile Condition="'$(BuildAll)' != 'true'">true</OverwriteSymbolTextFile>
    <OverwriteSymbolTextFile Condition="'$(BuildAll)' == 'true'">false</OverwriteSymbolTextFile>

    <TeamProject Condition="'$(TeamProject)' == ''">ExpertSuite</TeamProject>
    <TeamFoundationServerUrl Condition="'$(TeamFoundationServerUrl)' == ''">http://tfs:8080/tfs/aderant</TeamFoundationServerUrl>

    <SymbolPublishFile Condition="'$(SymbolPublishFile)' == ''">$(SolutionDirectoryPath)SymbolsToPublish.txt</SymbolPublishFile>
  </PropertyGroup>

  <Target Name="IndexSourcesAndPublishSymbolsCore">
    <BuildStep
     Condition="('$(IsDesktopBuild)'!='true') And ('$(IsCustomBuild)'!='true')"
     Message="$(BuildStepModuleName) Indexing sources and publish symbols"
     TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
     BuildUri="$(BuildUri)">
      <Output
        TaskParameter="id"
        PropertyName="BuildStepId" />
    </BuildStep>

    <Error Condition="'@(CompiledAssemblies)' == ''" Text="There are no outputs from the build" />

    <ItemGroup>
      <!-- Tranform all compiled outputs into a matching pdb -->
      <Symbols Include="@(ModuleBuildOutput->'%(RootDir)%(Directory)%(Filename).pdb')"
               Condition="'%(ModuleBuildOutput.OutputType)' == 'Module'" />

      <!-- Check if the pdb exists -->
      <AllSymbolFiles Include="@(Symbols)"
                      Condition="Exists(%(Symbols.FullPath))" />
    </ItemGroup>

    <ItemGroup>
      <SymbolFiles Include="@(AllSymbolFiles->Distinct())" />
    </ItemGroup>

    <SourceIndex
      SymbolFiles="@(SymbolFiles)"
      TeamProjectRootDirectory="-"
      TeamProjectName="$(TeamProject)"
      TeamProjectCollectionUri="$(TeamFoundationServerUrl)"
      FailOnNoSourceInformationFound="false"
      KeepTempFileForDebugging="false" />

    <Message Text="Using SymStore: $(SymStorePath)" />
    <Error Condition="!Exists('$(SymStorePath)')" Text="Cannot find SymStore.exe at $(SymStorePath)" />

    <!-- Append to the file symbol file during a build all - otherwise create new -->
    <WriteLinesToFile File="$(SymbolPublishFile)"
                      Lines="@(SymbolFiles)"
                      Overwrite="$(OverwriteSymbolTextFile)" />

    <CallTarget Targets="PublishSymbols" Condition="'$(BuildAll)' != 'true'" />

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true') And ('$(IsCustomBuild)'!='true')"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      Id="$(BuildStepId)"
      Status="Succeeded" />
  </Target>

  
  <Target Name="PublishSymbols">
    <BuildStep
       Condition="('$(IsDesktopBuild)'!='true') And ('$(IsCustomBuild)'!='true')"
       Message="$(BuildStepModuleName) Publish symbols"
       TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
       BuildUri="$(BuildUri)">
      <Output
        TaskParameter="id"
        PropertyName="BuildStepId" />
    </BuildStep>

    <PropertyGroup>
      <ProductName Condition="'$(ProductName)' == '' And '$(BuildAll)' != 'true'">[$(BranchName)][$(ModuleName)]</ProductName>
      <ProductName Condition="'$(ProductName)' == '' And '$(BuildAll)' == 'true'">[$(BranchName)][Build All]</ProductName>
      <ProductName>$(ProductName)[$(BuildUri)]</ProductName>
    </PropertyGroup>
    
    <!-- @ before the variable as we want @Symbols.txt so it is treated as a response file -->
    <PublishSymbols
      Condition="Exists('$(SymbolPublishFile)')"
      TeamProjectCollectionUri="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      Product="$(ProductName)"
      Version="$(FileVersion)"
      LockFile="$(SymbolStoreLock)"
      WindowsSdkPath="$(SymStorePath)"
      Command="add"
      Files="@$(SymbolPublishFile)"
      Store="$(SymbolStore)" />

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true') And ('$(IsCustomBuild)'!='true')"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      Id="$(BuildStepId)"
      Status="Succeeded" />
  </Target>


</Project>