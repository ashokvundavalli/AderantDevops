<?xml version="1.0" encoding="utf-8"?>
<Project
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  ToolsVersion="12.0">

  <!-- Gets the platform of an assembly (e.g. x86, x64 or AnyCPU) -->
  <UsingTask TaskName="GetAssemblyPlatform"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <!-- Gets the dependencies for a given module -->
  <UsingTask TaskName="GetDependencies"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="MakeSymlink"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="DependencyChecker"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="BuildConfigurationCheck"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="FilterModules"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="AsyncExec"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="ExtractWebModule"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="GetCopyLocalItemsToRemove"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <UsingTask TaskName="ParallelBuildProject"
             AssemblyFile="$(BuildToolsDirectory)\Aderant.Build.dll"
             Condition="'$(IsCustomBuild)' != 'true'" />

  <PropertyGroup>
    <!-- Inject per CSharp project overrides. This target is imported once for each CSharp project and allows us access to project level variables -->
    <CustomAfterMicrosoftCSharpTargets Condition="'$(IsCustomBuild)' != 'true'">$(BuildScriptsDirectory)Aderant.CSharp.targets</CustomAfterMicrosoftCSharpTargets>
    <CustomAfterMicrosoftCommonTargets Condition="'$(IsCustomBuild)' != 'true'">$(BuildScriptsDirectory)Aderant.CustomAfterMicrosoftCommon.targets</CustomAfterMicrosoftCommonTargets>

    <BuildToolsDirectory Condition="'$(BuildToolsDirectory)' == ''">$(BuildScriptsDirectory)..\Build.Tools\</BuildToolsDirectory>
    <PrepareBuildEnvironmentTargetImported>true</PrepareBuildEnvironmentTargetImported>
  </PropertyGroup>

  <!--
    ==========================================================================================
      Prepare Build Environment
      Builds the Build.Infrastructure assemblies and tools required by the build process
    ==========================================================================================
  -->
  <Target Name="PrepareBuildEnvironment" Condition="'$(IsCustomBuild)' == 'true'">
    <!-- This is just a stub -->
  </Target>
  
  <Target Name="PrepareBuildEnvironment" Condition="'$(IsCustomBuild)' != 'true'">
    
    <Error Condition="'$(BuildScriptsDirectory)' == ''" Text="No value specified for BuildScriptsDirectory" />
    
    <Message Text="Setting up build environment from: $(BuildScriptsDirectory)" />

    <ItemGroup>
      <Projects Include="$(BuildScriptsDirectory)..\Sources\FxCopCmd\FxCopCmd.csproj"></Projects>
      <Projects Include="$(BuildScriptsDirectory)..\Sources\Aderant.Build\Aderant.Build.csproj"></Projects>
    </ItemGroup>

    <MSBuild
      Projects="@(Projects)"
      BuildInParallel="true"
      UnloadProjectsOnCompletion="true" />
  
  </Target>
  
</Project>