<?xml version="1.0" encoding="utf-8"?>
<Project
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  ToolsVersion="14.0"
  TreatAsLocalProperty="BuildNumber">

  <PropertyGroup>
    <BuildInParallel Condition="'$(BuildInParallel)' == '' And '$(MSBuildNodeCount)' &gt; '1'">true</BuildInParallel>

    <LocalExpertBinariesDirectory>$(SolutionRoot)..\ExpertBinaries\</LocalExpertBinariesDirectory>
    <LocalExpertBinariesDirectory>$([System.IO.Path]::GetFullPath('$(LocalExpertBinariesDirectory)'))</LocalExpertBinariesDirectory>
    <LocalExpertBinariesDirectory Condition="'$(LocalExpertBinariesDirectory)' != '' and !HasTrailingSlash('$(LocalExpertBinariesDirectory)')">$(LocalExpertBinariesDirectory)\</LocalExpertBinariesDirectory>

    <PackageScriptsDirectory>$(BuildInfrastructureDirectory)\Src\Package\</PackageScriptsDirectory>
    <BuildScriptsDirectory>$(BuildInfrastructureDirectory)\Src\Build\</BuildScriptsDirectory>
    <BuildToolsDirectory>$(BuildInfrastructureDirectory)\Src\Build.Tools\</BuildToolsDirectory>
    <ExpertSourceDirectory>$(LocalExpertBinariesDirectory)ExpertSource\</ExpertSourceDirectory>
    <ProductManifestPath Condition="'$(ProductManifestPath)' == ''">$(PackageScriptsDirectory)ExpertManifest.xml</ProductManifestPath>

    <!-- Enables the use of a shared dependency directory to speed up the build -->
    <UseSharedDependencyDirectory>true</UseSharedDependencyDirectory>

    <SharedDependencyDirectory>$(SolutionRoot)Dependencies\</SharedDependencyDirectory>

    <BuildAllDropPath>$(DropLocation)</BuildAllDropPath>
  </PropertyGroup>

  <Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\TeamBuild\Microsoft.TeamFoundation.Build.targets" Condition="'$(IsDesktopBuild)' == 'false' And '$(TeamBuildRefPath)' != ''" />
  <Import Project="$(BuildScriptsDirectory)Aderant.Build.Common.targets" />
  <!-- Contains the branch build configuration -->
  <Import Project="$(ModuleList)" />

  <ItemGroup>
    <ModulesInBuild Include="@(Modules)" />
  </ItemGroup>

  <Target Name="GetAllModuleDependencies"
          DependsOnTargets="PrepareBuildEnvironment;SetBuildNumbers"
          BeforeTargets="BuildAndPackage"
          Condition="'$(UseSharedDependencyDirectory)' == 'true'">

    <Message Text="Using build scripts: $(BuildScriptsDirectory)" />

    <!-- Cull the module list if we are resuming the build from a certain point -->
    <Message Text="Resuming build from module $(BuildFrom)" Condition="'$(BuildFrom)' != ''" />

    <FilterModules
      Condition="'$(BuildFrom)' != ''"
      ModulesInBuild="@(ModulesInBuild)"
      BuildFrom="$(BuildFrom)">
      <Output TaskParameter="ModulesInBuild" ItemName="FilteredModuleList" />
    </FilterModules>

    <!-- Refresh the module list with the filtered list if needed -->
    <ItemGroup>
      <ModulesInBuild Remove="@(ModulesInBuild)" Condition="'$(BuildFrom)' != ''" />
      <ModulesInBuild Include="@(FilteredModuleList)" Condition="'$(BuildFrom)' != ''" />
    </ItemGroup>

    <!-- As we are in a build all we can get all of the dependencies in a batch operation -->
    <Message Text="Getting dependencies for build." />

    <Delete Files="$(SolutionRoot)\paket.dependencies" ContinueOnError="true" />
    <Delete Files="$(SolutionRoot)\paket.lock" ContinueOnError="true" />

    <GetDependencies
      ProductManifest="$(ProductManifestPath)"
      ModulesRootPath="$(SolutionRoot)"
      DependenciesDirectory="$(SharedDependencyDirectory)"
      DropPath="$(DropLocation)"
      ModulesInBuild="@(ModulesInBuild)"
      EnableVerboseLogging="$(PaketVerboseLogging)" />

    <ItemGroup>
      <ModuleDirectories Include="$([System.IO.Directory]::GetDirectories('$(SolutionRoot)'))"
                         Exclude="$(SolutionRoot)Build.Infrastructure;
                                  $(SharedDependencyDirectory);
                                  $(SolutionRoot)Dependencies;
                                  $(SolutionRoot)ThirdParty;
                                  $(SolutionRoot)TestRun" />
    </ItemGroup>

    <MakeSymlink
      Link="%(ModuleDirectories.FullPath)\Dependencies"
      Target="$(SharedDependencyDirectory)"
      Type="D" />

    <MakeSymlink
      Link="%(ModuleDirectories.FullPath)\packages"
      Target="$(SharedDependencyDirectory)\packages"
      Type="D" />

    <!--
        TFS: 122744
        We delete the cmsmsg files here. I don't think this is "correct" as it makes the build system
        aware of what it's building but there is a frustrating interplay here. If you resume the build from a location after the
        producution of the message file(s) then the build can fail on some application module builds. By delete the msg file from
        dependency directory it prevents the TextTranslator loading a message file while unit tests are running and then having those tests fail
        as the test are generally written to assume no message file is available and so don't expect to find translated strings.
      -->
    <ItemGroup>
      <MessageFiles Include="$(SharedDependencyDirectory)\cmsmsg*.msg;" />
    </ItemGroup>

    <Delete Files="@(MessageFiles)" />
  </Target>


  <!-- Tranforms inputs to this target file into item groups -->
  <Target Name="GetAllModuleDependenciesSetup"
          BeforeTargets="GetAllModuleDependencies">

    <Exec Command="rmdir /q /s $(SharedDependencyDirectory)" />

    <Exec Command="PowerShell.exe -NoProfile -File &quot;$(BuildScriptsDirectory)\CleanSymlinks.ps1&quot; $(SolutionRoot)" />

    <!-- If the directories already exists then we won't end up with a symlink in the MakeSymlink task -->
    <!-- Unfortunately the implemenattion of RemoveDir returns a removed directory even if the directory didn't exist so we need
         to check if the dir exists ourselves
    -->
    <ItemGroup>
      <DeleteList Include="@(ModulesInBuild->'%(FullPath)\Dependencies')" />
      <DeleteList Include="@(ModulesInBuild->'%(FullPath)\packages')" />
    </ItemGroup>

    <RemoveDir Directories="%(DeleteList.FullPath)" Condition="Exists('%(DeleteList.FullPath)')"
               ContinueOnError="true">
      <Output TaskParameter="RemovedDirectories" ItemName="RemovedDirectories" />
    </RemoveDir>

    <!--<Error Condition="'@(RemovedDirectories)' != ''" Text="The following directories should not be checked in @(RemovedDirectories)" />-->

    <MSBuild.Community.Tasks.DeleteTree Directories="$(SharedDependencyDirectory)" Recursive="true" />
    <MSBuild.Community.Tasks.DeleteTree Directories="$(SolutionRoot)\_BuildTemp" Recursive="true" />

    <MakeDir Directories="$(SharedDependencyDirectory);" />

    <ItemGroup>
      <Paket Include="$(SolutionRoot)\paket.*"></Paket>
    </ItemGroup>

    <Delete Files="@(Paket)" />

  </Target>


  <Target Name="ValidateBranchConfiguration" BeforeTargets="GetAllModuleDependencies">

    <ItemGroup>
      <ThirdPartyFiles Include="$(SolutionRoot)ThirdParty\**\bin\*.dll" />
    </ItemGroup>
  </Target>

  <Target Name="CreateParallelBuildProject"
          DependsOnTargets="GetAllModuleDependencies"
          AfterTargets="GetAllModuleDependencies">

    <Message Text="Creating parallel build project... "/>

    <PropertyGroup>
      <BranchBuildProject Condition="'$(BranchBuildProject)' == ''">$(SolutionRoot)BranchBuild.proj</BranchBuildProject>
    </PropertyGroup>

    <Delete Files="$(BranchBuildProject)" ContinueOnError="true" />

    <ParallelBuildProjectFactory
      ModulesDirectory="$(SolutionRoot)"
      ProductManifest="$(ProductManifestPath)"
      ModulesInBuild="@(ModulesInBuild)"
      ProjectFile="$(BranchBuildProject)" />

    <Error Condition="!Exists('$(BranchBuildProject)')" />
  </Target>

  <Target Name="Version" AfterTargets="GetAllModuleDependencies">
    <CallTarget Targets="SetBuildNumbers" />
  </Target>

  <!-- Override the the Team Build hook -->
  <Target Name="AfterDropBuild">
    <Message Text="After drop build" />
  </Target>


  <Target Name="BuildAndPackage">
    <!--
      To invoke this target on the desktop
      msbuild TFSBuild.proj @TFSBuild.rsp /p:DropLocation=\\na.aderant.com\expertsuite\<branch> /nr:false
    -->

    <Message Text="==========================================" Importance="High" />
    <Message Text="Build queue..."                             Importance="High" />
    <Message Text="%(ModulesInBuild.FullPath)"                 Importance="High" />
    <Message Text="==========================================" Importance="High" />

    <CallTarget Targets="BuildModulesParallel" />

    <SetBuildProperties
      Condition="'$(IsDesktopBuild)' == 'false'"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      CompilationStatus="Succeeded"
      TestStatus="Succeeded" />

  </Target>

  <!--
    ==========================================================================================
    This target will build the modules in the branch in parallel where possible.
    For parallel builds to work reliably it is important that project references are used so MS Build can calculate the
    build order of projects within the module correctly.
    ==========================================================================================
  -->
  <Target Name="BuildModulesParallel">

    <PropertyGroup>
      <CommonBuildProperties>
        BuildAll=true;
        BuildNumber=$(BuildNumber);
        TfsBuildNumber=$(BuildNumber);
        BuildScriptsDirectory=$(BuildScriptsDirectory);
        ProductManifestPath=$(ProductManifestPath);
        BuildToolsDirectory=$(BuildToolsDirectory);
        UseSharedDependencyDirectory=$(UseSharedDependencyDirectory);
        SharedDependencyDirectory=$(SharedDependencyDirectory);
        FileVersion=$(FileVersion);
        AssemblyVersion=$(AssemblyVersion);
        BuildFlavor=$(BuildFlavor)
      </CommonBuildProperties>
    </PropertyGroup>

    <Message Text="$(CommonBuildProperties)" />

    <Error Condition="!Exists('$(BranchBuildProject)')" Text="Did not find BranchBuild.proj "/>

    <MSBuild Projects="$(BranchBuildProject)"
             Properties="$(CommonBuildProperties)"
             BuildInParallel="$(BuildInParallel)" />

  </Target>


  <Target Name="Package" AfterTargets="BuildAndPackage">
    <!--
      To test via desktop
      msbuild TFSBuild.proj @TFSBuild.rsp /target:ZipProduct /p:LocalExpertBinariesDirectory=C:\Binaries\ /p:ZipFileDirectory=C:\Output\
    -->

    <OnError ExecuteTargets="SetBuildBreakProperties;OnBuildBreak" />
  </Target>


  <Target Name="ZipProduct" BeforeTargets="Package">

    <PropertyGroup>
      <PackageDropLocation Condition="'$(PackageDropLocation)' == ''">$(BuildAllDropPath)\$(BuildNumber)</PackageDropLocation>

      <!--@list for 7-zip-->
      <FilesToZipList>$(LocalExpertBinariesDirectory)cmd_ZipSourceFiles.lst</FilesToZipList>

      <ZipFile>$(LocalExpertBinariesDirectory)ExpertBinaries.zip</ZipFile>
      <EliteEnterpriseZipFile>$(LocalExpertBinariesDirectory)ExpertEEIntegrationBinaries.zip</EliteEnterpriseZipFile>
      <LicenseZipFile>$(LocalExpertBinariesDirectory)LicenseGenerator.zip</LicenseZipFile>
      <RegistrationZipFile>$(LocalExpertBinariesDirectory)RegistrationService.zip</RegistrationZipFile>
      <EliteEnterpriseBinOverrideDirectory>$(ExpertSourceDirectory)EEBin\</EliteEnterpriseBinOverrideDirectory>
      <PipelineOverrideDirectory>$(LocalExpertBinariesDirectory)\AutomatedDeployment\</PipelineOverrideDirectory>
    </PropertyGroup>

    <Delete Files="$(ZipFile);$(EliteEnterpriseZipFile)" />

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true')"
      Message="Zipping build output"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildURI)">
      <Output
        TaskParameter="id"
        PropertyName="BuildStepId" />
    </BuildStep>

    <Message Text="Zipping product files"/>

    <!-- Create ItemGroup used in Zip task.-->
    <ItemGroup>
      <SharedExclusions
        Include="$(ZipFile);
                 $(EliteEnterpriseZipFile);
                 $(ExpertSourceDirectory)Internal\**\*;
                 $(LocalExpertBinariesDirectory)**\_PublishedWebsites\**\*;
                 $(LocalExpertBinariesDirectory)**\LexisNexis*;
                 $(ExpertSourceDirectory)*iManage*;
                 $(LocalExpertBinariesDirectory)**\CodeCoverage\**\*;
                 $(LocalExpertBinariesDirectory)**\*CodeAnalysis*;
                 $(LocalExpertBinariesDirectory)**\System.dll*;
                 $(LocalExpertBinariesDirectory)**\System.Data.dll;
                 $(LocalExpertBinariesDirectory)**\System.Drawing*.dll;
                 $(LocalExpertBinariesDirectory)**\System.Windows.Forms*.dll;
                 $(LocalExpertBinariesDirectory)**\System.Xml*dll*;
                 $(ExpertSourceDirectory)*Microsoft.TeamFoundation.*dll*;
                 $(LocalExpertBinariesDirectory)**\*UnitTest*;
                 $(LocalExpertBinariesDirectory)**\TestLicenseRegistration*;
                 $(LocalExpertBinariesDirectory)**\*.deploy.cmd;
                 $(LocalExpertBinariesDirectory)**\*.deploy-readme.txt;
                 $(LocalExpertBinariesDirectory)**\*.SetParameters.*;
                 $(LocalExpertBinariesDirectory)**\*.BuildInfo.config;
                 $(LocalExpertBinariesDirectory)**\*.srcsrv;
                 $(LocalExpertBinariesDirectory)**\*.lic;
                 $(LocalExpertBinariesDirectory)**\DropFolderBuildNumbers.txt;" />

      <!-- Group of the roles shared between expert and elite -->
      <SharedRoles
        Include="$(ExpertSourceDirectory)commonapplications.role.xml;
                 $(ExpertSourceDirectory)configuration.role.xml;
                 $(ExpertSourceDirectory)customworkflows.role.xml;
                 $(ExpertSourceDirectory)firmcontrol.role.xml;
                 $(ExpertSourceDirectory)instrumentation.role.xml;
                 $(ExpertSourceDirectory)messaging.role.xml;
                 $(ExpertSourceDirectory)notes.role.xml;
                 $(ExpertSourceDirectory)queryservice.role.xml;
                 $(ExpertSourceDirectory)security.role.xml;
                 $(ExpertSourceDirectory)webcore.role.xml;
                 $(ExpertSourceDirectory)workflow.role.xml;
                 $(ExpertSourceDirectory)workflowauthoring.role.xml" />

      <!-- Group of the roles that should be elite only -->
      <EliteRoles
        Include="$(ExpertSourceDirectory)eliteintegration.role.xml;
                 $(ExpertSourceDirectory)matterplanningelite.role.xml" />

      <!-- Create a group of roles to exclude from elite (all roles minus the elite roles and shared roles) -->
      <EliteRoleExclusions
        Include="$(ExpertSourceDirectory)*.role.xml"
        Exclude="@(SharedRoles);@(EliteRoles)"/>

      <EliteOverrideFiles Include="$(EliteEnterpriseBinOverrideDirectory)**\*" />

      <EliteDocuments Include="$(LocalExpertBinariesDirectory)Elite Documentation\**\*.*"/>
      <Documents Include="$(LocalExpertBinariesDirectory)Documentation\**\*.*"/>

      <InquiriesFiles Include="$(ExpertSourceDirectory)Aderant.Inquiries*.dll"/>

      <IntegrationTestDependencies Include="$(LocalExpertBinariesDirectory)**\UnitTest.*Helpers.*" />

      <ZipSourceFiles
        Include="$(LocalExpertBinariesDirectory)**\*"
        Exclude="@(SharedExclusions);@(EliteRoles);@(EliteOverrideFiles);@(EliteDocuments)" />

      <ZipLicenseGeneratorFiles
        Include="$(ExpertSourceDirectory)Internal\LicenseGenerator\*.*" />
      <ZipRegistrationServiceFiles
        Include="$(ExpertSourceDirectory)Internal\RegistrationService\*.*" />

      <ZipSourceFiles
        Include="@(IntegrationTestDependencies)" />
    </ItemGroup>

    <!-- Create ZIP for ExpertSource -->
    <ItemGroup>
      <ZipSourceFiles Include="@(ZipSourceFiles)">
        <RelativePath>$([MSBuild]::MakeRelative($(LocalExpertBinariesDirectory), %(FullPath)))</RelativePath>
      </ZipSourceFiles>
    </ItemGroup>

    <WriteLinesToFile File="$(FilesToZipList)"
                      Lines="@(ZipSourceFiles->'%(RelativePath)')"
                      Overwrite="true" />

    <Exec Command='"$(BuildToolsDirectory)7za.exe" -bb a "$(ZipFile)" @$(FilesToZipList)'
          WorkingDirectory="$(LocalExpertBinariesDirectory)" />

    <Delete Files="$(FilesToZipList)" />

    <!-- Replace files in ExpertSource with the Elite bin folder overrides, used for things like message files and help. -->
    <Copy
      SourceFiles="@(EliteOverrideFiles)"
      DestinationFiles="@(EliteOverrideFiles->'$(ExpertSourceDirectory)%(RecursiveDir)%(Filename)%(Extension)')" />

    <!-- Essentially rename Elite.Help to Expert.Help -->
    <Copy
      SourceFiles="$(ExpertSourceDirectory)Help\Elite.Help.sfx"
      DestinationFiles="$(ExpertSourceDirectory)Help\Expert.Help.sfx" ContinueOnError="true" />

    <Delete
      Files="$(ExpertSourceDirectory)Help\Elite.Help.sfx" />

    <!-- Move the Elite specific docs into the Documents folder-->
    <Delete
      Files="@(Documents)" />

    <Copy
      SourceFiles="@(EliteDocuments)"
      DestinationFiles="@(EliteDocuments->'$(LocalExpertBinariesDirectory)Documentation\%(RecursiveDir)%(Filename)%(Extension)')" />

    <!-- This item group must go after the copy so that any moved files are included -->
    <ItemGroup>
      <ZipEliteEnterpriseSourceFiles
        Include="$(LocalExpertBinariesDirectory)**\*.*"
        Exclude="@(SharedExclusions);@(EliteRoleExclusions);@(EliteDocuments);@(InquiriesFiles)" />
    </ItemGroup>

    <!-- Create ZIP for Elite Enterprise -->
    <ItemGroup>
      <ZipEliteEnterpriseSourceFiles Include="@(ZipEliteEnterpriseSourceFiles)">
        <RelativePath>$([MSBuild]::MakeRelative($(LocalExpertBinariesDirectory), %(FullPath)))</RelativePath>
      </ZipEliteEnterpriseSourceFiles>
    </ItemGroup>

    <WriteLinesToFile File="$(FilesToZipList)"
                      Lines="@(ZipEliteEnterpriseSourceFiles->'%(RelativePath)')"
                      Overwrite="true" />

    <Exec Command='"$(BuildToolsDirectory)7za.exe" -bb a "$(EliteEnterpriseZipFile)" @$(FilesToZipList)'
          WorkingDirectory="$(LocalExpertBinariesDirectory)" />

    <!-- Create ZIP for LicenseGenerator -->
    <MSBuild.Community.Tasks.Zip
      Files="@(ZipLicenseGeneratorFiles)"
      ZipFileName="$(LicenseZipFile)"
      WorkingDirectory="$(ExpertSourceDirectory)Internal\LicenseGenerator"
      ParallelCompression="false" />

    <!-- Create ZIP for RegistrationService -->
    <MSBuild.Community.Tasks.Zip
      Files="@(ZipRegistrationServiceFiles)"
      ZipFileName="$(RegistrationZipFile)"
      WorkingDirectory="$(ExpertSourceDirectory)Internal\RegistrationService"
      ParallelCompression="false" />

    <Copy SourceFiles="$(ZipFile);$(EliteEnterpriseZipFile);$(LicenseZipFile);$(RegistrationZipFile)"
          DestinationFolder="$(PackageDropLocation)" />

    <!-- Copy commit info file and scripts over. -->
    <ItemGroup>
      <CommitInfoFiles Include="
                       $(LocalExpertBinariesDirectory)..\CommitInfo.json;
                       $(LocalExpertBinariesDirectory)..\persist-build.ps1;
                       $(LocalExpertBinariesDirectory)..\persist-build.bat;
                       $(LocalExpertBinariesDirectory)..\undo-buildpersistence.bat;
                       $(LocalExpertBinariesDirectory)..\_readme.txt" />
    </ItemGroup>

    <Copy
      SourceFiles="@(CommitInfoFiles)"
      DestinationFolder="$(PackageDropLocation)\ReleaseManagement\"
      ContinueOnError="true" />

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true')"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      Id="$(BuildStepId)"
      Status="Succeeded" />


    <OnError ExecuteTargets="MarkBuildStepAsFailed" />
  </Target>

  <!--
  ==========================================================================================
  Package the built modules and place in this builds output folder on the drop.
  ==========================================================================================
  -->
  <Target Name="GetProduct" BeforeTargets="ZipProduct">

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true')"
      Message="Package Product"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildURI)">

      <Output
        TaskParameter="id"
        PropertyName="BuildStepId" />
    </BuildStep>

    <PropertyGroup>
      <_GetProductScript Condition="'$(_GetProductScript)' == ''">GetProduct.ps1</_GetProductScript>
      <_GetProductScript Condition="'$(UseGetProductTests)' == 'true'">GetProductTests.ps1</_GetProductScript>
    </PropertyGroup>

    <MakeDir Directories="$(LocalExpertBinariesDirectory)"
             Condition="!Exists('$(LocalExpertBinariesDirectory)')" />

    <Exec Condition="'$(BuildServerImage)' == 'true'"
      ContinueOnError="false"
      IgnoreExitCode="false"
      Command="Powershell -noprofile $(PackageScriptsDirectory)$(_GetProductScript) -productManifestPath $(ProductManifestPath) -dropRoot $(BuildAllDropPath) -binariesDirectory $(LocalExpertBinariesDirectory) -systemMapConnectionString '$(ExpertDatabaseConnectionStringForSystemMap)' -getDebugFiles $true -teamProject $(TeamProject) -tfvcBranchName $(BranchName) -tfvcSourceGetVersion $(SourceGetVersion) -buildUri $(BuildUri) -tfsBuildNumber $(BuildNumber) -createServerImage"
      WorkingDirectory="$(PackageScriptsDirectory)" />

    <Exec Condition="'$(BuildServerImage)' != 'true'"
      ContinueOnError="false"
      IgnoreExitCode="false"
      Command="Powershell -noprofile $(PackageScriptsDirectory)$(_GetProductScript) -productManifestPath $(ProductManifestPath) -dropRoot $(BuildAllDropPath) -binariesDirectory $(LocalExpertBinariesDirectory) -systemMapConnectionString '$(ExpertDatabaseConnectionStringForSystemMap)' -getDebugFiles $true -teamProject $(TeamProject) -tfvcBranchName $(BranchName) -tfvcSourceGetVersion $(SourceGetVersion) -buildUri $(BuildUri) -tfsBuildNumber $(BuildNumber)"
      WorkingDirectory="$(PackageScriptsDirectory)" />

    <BuildStep
      Condition="('$(IsDesktopBuild)'!='true')"
      TeamFoundationServerUrl="$(TeamFoundationServerUrl)"
      BuildUri="$(BuildUri)"
      Id="$(BuildStepId)"
      Status="Succeeded" />

    <OnError ExecuteTargets="MarkBuildStepAsFailed" />
  </Target>


  <UsingTask
    TaskName="MergeParameters"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="$(CodeTaskFactoryAssembly)">
    <ParameterGroup>
      <Source ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <Target ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" Output="true" />
      <MergeResult ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System.Core" />
      <Reference Include="System.Xml" />
      <Reference Include="System.Xml.Linq "/>
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="System.Linq" />
      <Using Namespace="System.Xml.Linq" />
      <Using Namespace="System.Text.RegularExpressions" />
      <Code>
        <![CDATA[
  List<ITaskItem> items = new List<ITaskItem>(Target);

  foreach (var sourceItem in Source) {
      var sourceKey = sourceItem.ItemSpec.Split('=')[0];

      bool add = true;

      foreach (var item in Target) {
          var itemKey = item.ItemSpec.Split('=')[0];

          if (itemKey == sourceKey) {
            Log.LogMessage("ItemGroup already contains key: " + itemKey, null);
            add = false;
            break;
          }
      }

      if (add) {
          items.Add(sourceItem);
      }
  }

  MergeResult = items.ToArray();
]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="MarkBuildStepAsFailed" />
</Project>
