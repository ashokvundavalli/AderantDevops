<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
         ToolsVersion="14.0">

  <PropertyGroup>
    <DefaultLanguageSourceExtension Condition="'$(DefaultLanguageSourceExtension)' == ''">.cs</DefaultLanguageSourceExtension>
    <Language Condition="'$(Language)' == ''">CS</Language>
  </PropertyGroup>

  <PropertyGroup>
    <SetVersionAttributesDependsOn Condition="'$(IsCustomBuild)' != 'true' And '$(ProjectGuid)' != ''">
      $(SetVersionAttributesDependsOn);
      ReadVersionInfo;
      GenerateAssemblyInfo;
      AssemblyInfoUpdateCopyright;
    </SetVersionAttributesDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <SetVersionAttributesBeforeTargets Condition="'$(Language)' == 'C#'">
      BeforeCompile
    </SetVersionAttributesBeforeTargets>
  </PropertyGroup>

  <!-- Stub that lets us hook BeforeCompile without breaking others that also override BeforeCompile -->
  <Target Name="SetVersionAttributes" BeforeTargets="$(PrepareResourcesDependsOn);$(SetVersionAttributesBeforeTargets)" DependsOnTargets="$(SetVersionAttributesDependsOn)" />


  <PropertyGroup>
    <IsIntegrationTest>$(MSBuildProjectName.StartsWith('IntegrationTest.'))</IsIntegrationTest>
    <CreateGeneratedAssemblyInfoInputsCacheFileDependsOn>
      GatherAssemblyAttributes;
      FindRoleFiles
    </CreateGeneratedAssemblyInfoInputsCacheFileDependsOn>
  </PropertyGroup>


  <Target Name="GatherAssemblyAttributes">

    <PropertyGroup>
      <!-- Path.Combine to try handle trailing/non-trailing slashes -->
      <_GitDir Condition="'$(_GitDir)' == ''">$([System.IO.Path]::Combine($(SolutionDirectoryPath), '.git'))</_GitDir>

      <_HasGitDir Condition="'$(_HasGitDir)' == ''">false</_HasGitDir>
      <_HasGitDir Condition="Exists($(_GitDir))">true</_HasGitDir>

      <!-- Slurp in the paket.lock data as well -->
      <_PaketLockFile>$([System.IO.Path]::Combine($(SolutionDirectoryPath), 'paket.lock'))</_PaketLockFile>
      <_PaketLockText Condition="Exists($(_PaketLockFile))">$([System.IO.File]::ReadAllText($(_PaketLockFile)))</_PaketLockText>

      <CIEnabled Condition="'$(IsIntegrationTest)' == 'true' And '$(CIEnabled)' == ''">false</CIEnabled>
    </PropertyGroup>

    <GitVersion
      Condition="'$(_HasGitDir)' == 'true'"
      WorkingDirectory="$(_GitDir)">
      <Output PropertyName="GitCanonicalBranchName" TaskParameter="CanonicalBranchName" />
      <Output PropertyName="GitSha" TaskParameter="Sha" />
    </GitVersion>

    <ItemGroup>
      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(_HasGitDir)' == 'true'">
        <_Parameter1>Git.BranchName</_Parameter1>
        <_Parameter2>$(GitCanonicalBranchName)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(_HasGitDir)' == 'true'">
        <_Parameter1>Git.Sha</_Parameter1>
        <_Parameter2>$(GitSha)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(BUILD_BUILDID)' != ''">
        <_Parameter1>Build.Id</_Parameter1>
        <_Parameter2>$(BUILD_BUILDID)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(BUILD_SOURCEVERSION)' != ''">
        <_Parameter1>Build.SourceVersion</_Parameter1>
        <_Parameter2>$(BUILD_SOURCEVERSION)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(BUILD_REPOSITORY_URI)' != ''">
        <_Parameter1>Build.RepositoiryUri</_Parameter1>
        <_Parameter2>$(BUILD_REPOSITORY_URI)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(_PaketLockText)' != ''">
        <_Parameter1>Build.PaketLock</_Parameter1>
        <_Parameter2>$(_PaketLockText)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(BuildFlavor)' != ''">
        <_Parameter1>Build.Flavor</_Parameter1>
        <_Parameter2>$(BuildFlavor)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(IsIntegrationTest)' == 'true'">
        <_Parameter1>CIEnabled</_Parameter1>
        <_Parameter2>$(CIEnabled)</_Parameter2>
      </_AssemblyAttributes>

      <_AssemblyAttributes Include="System.Reflection.AssemblyMetadataAttribute" Condition="'$(IsIntegrationTest)' == 'true' And '$(CICategory)' != ''">
        <_Parameter1>CICategory</_Parameter1>
        <_Parameter2>$(CICategory)</_Parameter2>
      </_AssemblyAttributes>
    </ItemGroup>
  </Target>


  <Target Name="FindRoleFiles">
    <RoleManifestPackageIdentifier Condition="'$(IsIntegrationTest)' == 'true'"
      ManifestSearchDirectories="@(ManifestSearchDirectories)"
      DependentRoles="@(DependentRoles)"
      PackageBlacklist="@(PackageBlacklist)" >
      <Output TaskParameter="DependentPackages" ItemName="DependentPackages" />
    </RoleManifestPackageIdentifier>

    <ItemGroup>
      <_AssemblyAttributes Condition="'$(IsIntegrationTest)' == 'true'" Include="@(DependentPackages)" />
    </ItemGroup>
  </Target>


  <!--
    To allow version changes to be respected on incremental builds (e.g. through CLI parameters),
    create a hash of all assembly attributes so that the cache file will change with the calculated
    assembly attribute values and MS Build will then execute CoreGenerateAssembly to generate a new file.
  -->
  <Target Name="CreateGeneratedAssemblyInfoInputsCacheFile"
          DependsOnTargets="$(CreateGeneratedAssemblyInfoInputsCacheFileDependsOn)">

    <PropertyGroup>
      <GeneratedAssemblyInfoInputsCacheFile>$(IntermediateOutputPath)Versioning.AssemblyInfoInputs.cache</GeneratedAssemblyInfoInputsCacheFile>
      <GeneratedAssemblyInfoFile Condition="'$(GeneratedAssemblyInfoFile)' == ''">$(IntermediateOutputPath)AssemblyInfo.g.cs</GeneratedAssemblyInfoFile>
    </PropertyGroup>

    <Aderant.Build.Tasks.HashItems ItemsToHash="@(_AssemblyAttributes->'%(Identity)%(_Parameter2)')">
      <Output TaskParameter="HashResult" PropertyName="__AssemblyAttributesHash" />
    </Aderant.Build.Tasks.HashItems>

    <Aderant.Build.Tasks.WriteLinesToFile
      Lines="$(__AssemblyAttributesHash)"
      File="$(GeneratedAssemblyInfoInputsCacheFile)"
      Overwrite="true"
      WriteOnlyWhenDifferent="true" />

    <ItemGroup>
      <FileWrites Include="$(GeneratedAssemblyInfoInputsCacheFile)" />
    </ItemGroup>

  </Target>


  <PropertyGroup>
    <GenerateAssemblyInfoDependsOn>
      $(GenerateAssemblyInfoDependsOn);
      CoreGenerateAssemblyInfo
    </GenerateAssemblyInfoDependsOn>
  </PropertyGroup>


  <Target Name="GenerateAssemblyInfo"
          DependsOnTargets="$(GenerateAssemblyInfoDependsOn)" />


  <Target Name="CoreGenerateAssemblyInfo"
          DependsOnTargets="CreateGeneratedAssemblyInfoInputsCacheFile"
          Inputs="$(GeneratedAssemblyInfoInputsCacheFile)"
          Outputs="$(GeneratedAssemblyInfoFile)">

    <Error Condition="'@(_AssemblyAttributes)' == ''"        Text="No assembly attributes specified" />
    <Error Condition="'$(GeneratedAssemblyInfoFile)' == ''"  Text="GeneratedAssemblyInfoFile is undefined" />

    <WriteCodeFragment AssemblyAttributes="@(_AssemblyAttributes)"
                       Language="CS"
                       OutputFile="$(GeneratedAssemblyInfoFile)">
    </WriteCodeFragment>

  </Target>


  <Target Name="FindCommonAssemblyInfo">

    <!-- Find CommonAssemblyInfo.cs in the "Compile" Items. Remove it from "Compile" Items because we will use a modified version instead. -->
    <ItemGroup>
      <CommonAssemblyInfoFile Include="@(Compile)" Condition="%(Filename) == 'CommonAssemblyInfo' And %(Extension) == '.cs'" />
      <!-- Now remove the original element -->
      <Compile Remove="@(CommonAssemblyInfoFile)" Condition="@(CommonAssemblyInfoFile) != ''" />
    </ItemGroup>

    <PropertyGroup>
      <NewCommonAssemblyInfoFile>$(IntermediateOutputPath)CommonAssemblyInfo.cs</NewCommonAssemblyInfoFile>
    </PropertyGroup>

    <!-- Include the modified CommonAssemblyInfo.cs file in "Compile" items (instead of the original). -->
    <ItemGroup>
      <Compile Include="$(NewCommonAssemblyInfoFile)" Condition="@(CommonAssemblyInfoFile) != ''" />
    </ItemGroup>

  </Target>


  <!--
      Creates modified version of CommonAssemblyInfo.cs without touching the original file so we don't upset
      incremental builds
  -->
  <Target Name="AssemblyInfoUpdateCopyright"
          DependsOnTargets="FindCommonAssemblyInfo"
          Inputs="@(CommonAssemblyInfoFile)"
          Outputs="$(NewCommonAssemblyInfoFile)">

    <Copy SourceFiles="@(CommonAssemblyInfoFile)"
          DestinationFiles="$(NewCommonAssemblyInfoFile)"
          OverwriteReadOnlyFiles="true" />

    <!-- Update copyright, $1, $2 and $4 are capture groups -->
    <MSBuild.Community.Tasks.FileUpdate
      Condition="@(CommonAssemblyInfoFile) != ''"
      Encoding="utf-8-without-bom"
      Files="$(NewCommonAssemblyInfoFile)"
      IgnoreCase="true"
      Multiline="true"
      Singleline="false"
      Regex="(.*?AssemblyCopyright)(.*?\d{4})(\s*-\s*\d{4})?(.*)"
      ReplacementText="$1$2-$([System.DateTime]::Now.Year)$4">
    </MSBuild.Community.Tasks.FileUpdate>

    <ItemGroup>
      <FileWrites Include="$(NewCommonAssemblyInfoFile)" />
    </ItemGroup>

  </Target>


  <Target Name="ReadVersionInfo" DependsOnTargets="FindCommonAssemblyInfo">

    <ReadAssemblyInfo AssemblyInfoFiles="@(CommonAssemblyInfoFile)">
      <Output ItemName="CommonAssemblyInformationalVersion" TaskParameter="AssemblyInformationalVersion" />
      <Output ItemName="CommonAssemblyVersion"              TaskParameter="AssemblyVersion" />
      <Output ItemName="CommonAssemblyFileVersion"          TaskParameter="AssemblyFileVersion" />
    </ReadAssemblyInfo>

  </Target>

</Project>