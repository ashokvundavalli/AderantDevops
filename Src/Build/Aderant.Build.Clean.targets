<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="14.0">

  <!--
    ==========================================================================================
        Clean
    ==========================================================================================
  -->
  <Target Name="CleanBin" DependsOnTargets="CleanAlways" Condition="'$(CleanBin)' == 'true'">

    <RemoveDir Directories="$(SolutionDirectoryPath)Bin\Module" ContinueOnError="true" />
    <RemoveDir Directories="$(SolutionDirectoryPath)Src\$(ModuleName)\bin" ContinueOnError="true" />

    <!-- These can be symlinks so delete them directly -->
    <RemoveDir Directories="$(BinTestDirectory)Dependencies" ContinueOnError="true" />
    <RemoveDir Directories="$(BinTestDirectory)ModuleBin" ContinueOnError="true" />

    <ItemGroup>
      <Folders Include="$(SolutionDirectoryPath)Bin\" />
      <Folders Include="$(SolutionDirectoryPath)BuildTemp\" />
      <Folders Include="$(ModuleBuildTempDirectory)\" />
      <Folders Include="$(SolutionDirectoryPath)Src\" />
      <Folders Include="$(SolutionDirectoryPath)CommonBuild\" />
      <Folders Include="$(SolutionDirectoryPath)TestResults\" />
    </ItemGroup>

    <Error Condition="!HasTrailingSlash('%(Folders.FullPath)')"
           Text="All paths in the Folders item group must end with a trailing slash" />

    <ItemGroup>
      <!-- (?i) means case insensitive -->
      <Files Include="%(Folders.RootDir)%(Folders.Directory)\**\obj\**" Condition="$([System.Text.RegularExpressions.Regex]::IsMatch('%(Folders.FullPath)', `(?i)Src`))" />
      <Files Include="%(Folders.RootDir)%(Folders.Directory)\**\**" Condition="!$([System.Text.RegularExpressions.Regex]::IsMatch('%(Folders.FullPath)', `(?i)Src`))" />
    </ItemGroup>

    <ItemGroup>
      <FilesToDelete Include="@(Files)" />
      <FoldersToDelete Include="%(Files.RelativeDir)" />
    </ItemGroup>

    <Message Condition="@(FilesToDelete) != ''" Text="Files to clean: %(FilesToDelete.FullPath)" />
    <Message Condition="@(FoldersToDelete) != ''" Text="Folders to clean: %(FoldersToDelete.FullPath)" />

    <MSBuild.Community.Tasks.Attrib
      ReadOnly="false"
      Files="@(FilesToDelete)" />

    <Delete
      Files="@(FilesToDelete)"
      ContinueOnError="true" />

    <RemoveDir
      Directories="@(FoldersToDelete)"
      ContinueOnError="true" />

    <MakeDir Directories="$(BinModuleDirectory)" />
  </Target>


  <Target Name="CleanAlways">
    <!-- Always remove these files and folders as Visual Studio likes to produce these folders in abundance -->
    <Delete Files="$(SolutionDirectoryPath)TestResults\**\*" ContinueOnError="true" />
    <Delete Files="$(ModuleBuildDirectory)TestResults\**\*" ContinueOnError="true" />
    <RemoveDir Directories="$(SolutionDirectoryPath)TestResults" ContinueOnError="true" />
    <RemoveDir Directories="$(ModuleBuildDirectory)TestResults" ContinueOnError="true" />
  </Target>

</Project>