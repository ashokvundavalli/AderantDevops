<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="Current">
  <!-- External targets: GetServerImageDependencies, RunTests
     External variables: ArtifactStagingDirectory, BuildToolsDirectory, ExpertSourceDirectory, SolutionRoot, ImageWorkingDirectory, ImageToolingDirectory, DeploymentEngine, SharedDependencyDirectory, ImpactedTestProjects, ParametersFile, RunTests -->
  <PropertyGroup>
    <DeploymentTargets>$(SharedDependencyDirectory)\packages\Aderant.Deployment.Internal\lib\Targets\</DeploymentTargets>
    <ServerImageTargetExists Condition="Exists('$(DeploymentTargets)Aderant.Build.ServerImage.targets')">true</ServerImageTargetExists>
    <DeployTargetExists Condition="Exists('$(DeploymentTargets)Aderant.Build.DeployCI.targets')">true</DeployTargetExists>
  </PropertyGroup>

  <Import Project="Aderant.Build.Testing.targets" />
  <Import Project="$(DeploymentTargets)Aderant.Build.ServerImage.targets" Condition="'$(ServerImageTargetExists)' == 'true'" />
  <Import Project="$(DeploymentTargets)Aderant.Build.DeployCI.targets" Condition="'$(DeployTargetExists)' == 'true'" />

  <PropertyGroup>
    <!-- Allows environment variables to override RSP parameters -->
    <_RunIntegrationTests Condition="'$(_RunIntegrationTests)' == ''">$([System.Environment]::GetEnvironmentVariable('RunIntegrationTests'))</_RunIntegrationTests>
    <_RunIntegrationTests Condition="'$(_RunIntegrationTests)' == ''">$(RunIntegrationTests)</_RunIntegrationTests>
    <_RunIntegrationTests Condition="'$(IsDesktopBuild)' == 'true' And '$(RunDesktopIntegrationTests)' != ''">$(RunDesktopIntegrationTests)</_RunIntegrationTests>
    <_RunIntegrationTests Condition="'$(_RunIntegrationTests)' == ''">false</_RunIntegrationTests>

    <PowerShellExe Condition=" '$(PowerShellExe)' == ''">$(SystemRoot)\sysnative\WindowsPowerShell\v1.0\powershell.exe</PowerShellExe>

    <RunIntegrationTestsDependsOn Condition="'$(DeployTargetExists)' == 'true'">
      DeployCIEnvironment;
    </RunIntegrationTestsDependsOn>

  </PropertyGroup>


  <Target Name="RunIntegrationTestsCore" DependsOnTargets="RunIntegrationTests">
  </Target>


  <Target Name="RunIntegrationTests"
    DependsOnTargets="$(RunIntegrationTestsDependsOn)"
    Condition="'$(_RunIntegrationTests)' == 'true'">

    <PropertyGroup>
      <TestPattern>IntegrationTest</TestPattern>
    </PropertyGroup>

    <!-- Invoke the RunTests target from Aderant.Build.Testing.targets -->
    <CallTarget Targets="RunTestsCore" />

    <OnError ExecuteTargets="LightsOff;ShowTestFailureHelp" Condition="'$(DeployTargetExists)' == 'true'"/>

  </Target>


  <Target Name="LightsOffWrap" DependsOnTargets="RunIntegrationTests" AfterTargets="RunIntegrationTests">
    <CallTarget Targets="LightsOff" Condition="'$(DeployTargetExists)' == 'true'"/>
  </Target>

</Project>